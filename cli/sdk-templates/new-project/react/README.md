# {{plugin_name_title}}

A VST3/CLAP audio plugin built with the [Wavecraft SDK](https://github.com/RonHouben/wavecraft).

**Generated by:** `wavecraft create {{plugin_name}}`

---

## Quick Start

### Prerequisites

- **Rust** 1.75+ ([install](https://rustup.rs/))
- **Node.js** 18+ ([install](https://nodejs.org/))
- **macOS** (primary), Windows/Linux (secondary support)

### Build Your Plugin in 3 Steps

```bash
# 1. Install UI dependencies
cd ui && npm install && cd ..

# 2. Start development servers (Engine + UI hot reload)
cargo xtask dev
# Open http://localhost:5173 in your browser

# 3. Build plugin bundles when ready
cargo xtask bundle --release
```

The plugin bundles are created in `target/bundled/`:
- `{{plugin_name}}.vst3/` — VST3 format
- `{{plugin_name}}.clap` — CLAP format

### Install to System

```bash
cargo xtask install
```

This copies the bundles to your system plugin directories.

---

## Project Structure

```
{{plugin_name}}/
├── Cargo.toml       # Workspace root
├── engine/          # Rust audio engine
│   ├── src/
│   │   ├── lib.rs            # Plugin assembly (signal chain + metadata)
│   │   └── processors/       # Your custom DSP processors
│   │       ├── mod.rs         # Module exports
│   │       └── oscillator.rs  # Example: sine-wave oscillator
│   ├── xtask/       # Build automation (dev, bundle, install, etc.)
│   └── Cargo.toml   # Wavecraft SDK dependencies (git tags)
├── ui/              # React UI (TypeScript + Tailwind CSS)
│   ├── src/
│   │   ├── App.tsx
│   │   ├── components/  # Parameter controls, meters
│   │   └── lib/wavecraft-ipc/  # IPC client for Engine ↔ UI
│   ├── package.json
│   └── vite.config.ts
└── README.md
```

### Key Files

| File | Purpose |
|------|---------|
| `engine/src/lib.rs` | Plugin assembly — signal chain + `wavecraft_plugin!` DSL |
| `engine/src/processors/` | Folder for your custom `Processor` implementations |
| `engine/src/processors/oscillator.rs` | Example oscillator (sine wave, frequency + level params) |
| `ui/src/App.tsx` | User interface layout with parameter controls |
| `engine/Cargo.toml` | Wavecraft SDK dependencies via git tags |

---

## Development Workflow

### Understanding the Project Layout

Your plugin has two main parts:

1. **`engine/src/lib.rs`** — Assembles the signal chain and declares the plugin.
2. **`engine/src/processors/`** — Contains your custom DSP code (one file per processor).

```rust
// engine/src/lib.rs
use wavecraft::prelude::*;

mod processors;
use processors::Oscillator;

// Built-in processors need named wrappers (parameter-ID prefix)
wavecraft_processor!(InputGain  => Gain);
wavecraft_processor!(OutputGain => Gain);

// Custom processors (like Oscillator) are used directly in the signal chain.
// They already implement the Processor trait with their own parameters.

wavecraft_plugin! {
    name: "{{plugin_name_title}}",
    signal: SignalChain![InputGain, OutputGain],
    // To hear the oscillator, swap the line above with:
    // signal: SignalChain![InputGain, Oscillator, OutputGain],
}
```

**Metadata Derivation:** The plugin automatically derives:
- **Vendor/Author** from `Cargo.toml` `authors` field
- **URL** from `homepage` or `repository` field
- **Email** parsed from authors

### Enabling the Oscillator Example

The template ships with a complete oscillator in `processors/oscillator.rs`.
To hear it, switch the signal-chain line in `lib.rs`:

```rust
// Before (silent — gain only, requires external audio input)
signal: SignalChain![InputGain, OutputGain],

// After (generates a 440 Hz sine wave)
signal: SignalChain![InputGain, Oscillator, OutputGain],
```

Rebuild (`cargo xtask bundle`) and open the plugin in your DAW to hear the tone.

### Adding a New Processor

Follow these four steps:

1. **Create the file** — e.g. `engine/src/processors/filter.rs`
2. **Implement the trait:**

```rust
use wavecraft::prelude::*;
use wavecraft::ProcessorParams;

#[derive(ProcessorParams, Default, Clone)]
pub struct FilterParams {
    #[param(range = "20.0..=20000.0", default = 1000.0, unit = "Hz", factor = 2.5)]
    pub cutoff: f32,
}

#[derive(Default)]
pub struct Filter { /* state fields */ }

impl Processor for Filter {
    type Params = FilterParams;

    fn process(
        &mut self,
        buffer: &mut [&mut [f32]],
        _transport: &Transport,
        params: &Self::Params,
    ) {
        // Your DSP code here (must be real-time safe!)
        let _ = params.cutoff; // use the parameter
    }
}
```

3. **Export in mod.rs:**

```rust
// engine/src/processors/mod.rs
pub mod oscillator;
pub mod filter;          // ← add

pub use oscillator::Oscillator;
pub use filter::Filter;  // ← add
```

4. **Wire into the signal chain:**

```rust
// engine/src/lib.rs
use processors::{Oscillator, Filter};

// Custom processors are used directly — no wavecraft_processor! wrapper needed.
wavecraft_plugin! {
    name: "{{plugin_name_title}}",
    signal: SignalChain![InputGain, Oscillator, Filter, OutputGain],
}
```

The UI will automatically discover the new parameters — no React changes needed.

### Real-Time Safety Rules

⚠️ **Critical:** Code in `process()` runs on the audio thread and must follow strict rules:

**Never do:**
- ❌ Allocate memory (`Vec::push`, `String::from`, `Box::new`)
- ❌ Lock mutexes or use blocking operations
- ❌ Make system calls (file I/O, network, logging)
- ❌ Use `println!` or any I/O

**Always do:**
- ✅ Use pre-allocated buffers
- ✅ Use atomic types for shared state
- ✅ Keep operations deterministic and fast
- ✅ Use `#[inline]` for hot-path functions

### Development Commands

```bash
# Start dev servers (Engine WebSocket + UI with hot reload + Auto audio if configured)
cargo xtask dev

# Build debug plugin (fast compilation)
cargo xtask bundle

# Build release plugin (optimized)
cargo xtask bundle --release

# Install to system directories
cargo xtask install

# Run linters
cargo xtask lint

# Run tests
cargo xtask test

# Clean build artifacts
cargo xtask clean
```

### Audio Testing with Real Input

`cargo xtask dev` automatically enables real-time audio input testing when available:

**What happens:**
- If your project has `dev-audio` binary configured, it compiles and starts automatically
- Audio flows from your system microphone through your DSP code
- Meters update in real-time with actual audio levels
- Parameter changes apply instantly to the audio stream
- UI hot-reloading works while audio is running

**Note:** If audio hardware is unavailable, the dev server continues in browser-only mode with metering. Audio processing uses FFI to load your plugin's DSP code automatically — no extra binary needed.

---

## Plugin Configuration

Plugin metadata is configured in two places:

### engine/Cargo.toml

```toml
[package]
name = "{{plugin_name}}"
authors = ["Your Name <your.email@example.com>"]
homepage = "https://yourproject.com"
```

These fields are automatically used for plugin metadata (vendor, URL, email).

### engine/src/lib.rs

```rust
wavecraft_plugin! {
    name: "{{plugin_name_title}}",    // Display name in DAW
    signal: SignalChain![InputGain, OutputGain],  // Processor chain entry point
}
```

**Note:** Vendor, URL, and email are derived from Cargo.toml at compile time.

### Unique Plugin IDs

**Important:** The template generates IDs based on your package name. Customize if needed:

**CLAP ID:** In `engine/Cargo.toml`:
```toml
[package.metadata.clap]
id = "com.{{plugin_name}}"  # Default: com.your_package_name
```

**VST3 Class ID:** Auto-generated from plugin name, but can be customized in `wavecraft_plugin!`:
```rust
wavecraft_plugin! {
    // ... other fields
    vst3_class_id: *b"YourUniqueID0000",  // Optional: 16-byte unique ID
}
```

---

## Wavecraft SDK Overview

Your plugin depends on Wavecraft SDK crates via git tags (until crates.io publishing):

```toml
# engine/Cargo.toml
[dependencies]
wavecraft-core = { git = "https://github.com/RonHouben/wavecraft", tag = "{{sdk_version}}" }
wavecraft-protocol = { git = "https://github.com/RonHouben/wavecraft", tag = "{{sdk_version}}" }
# ...
```

| Crate | Purpose |
|-------|---------|
| `wavecraft-core` | Main framework, nih-plug integration, declarative DSL, editor |
| `wavecraft-protocol` | Parameter definitions, IPC contracts |
| `wavecraft-dsp` | DSP traits (`Processor`), utilities, built-in processors |
| `wavecraft-bridge` | IPC handler (UI ↔ Audio communication) |
| `wavecraft-metering` | Real-time safe metering with SPSC ring buffers |

### Core Traits

**`Processor` trait** — Implement this for custom DSP:
```rust
pub trait Processor {
    type Params: ProcessorParams + Default + Send + Sync + 'static;

    fn process(&mut self, buffer: &mut [&mut [f32]], transport: &Transport, params: &Self::Params);
    fn set_sample_rate(&mut self, _sample_rate: f32) {}
    fn reset(&mut self) {}
}
```

**`ProcessorParams` derive** — Auto-generate parameter structs:
```rust
#[derive(ProcessorParams, Default)]
struct MyParams {
    #[param(range = "0.0..=1.0", default = 0.5)]
    level: f32,
}
```

---

## Building for Distribution

### Build Release Bundles

```bash
cargo xtask bundle --release
```

This creates optimized plugin bundles in `target/bundled/`:
- `{{plugin_name}}.vst3/` — VST3 format
- `{{plugin_name}}.clap` — CLAP format

### Installation Locations

| Platform | VST3 | CLAP |
|----------|------|------|
| macOS | `~/Library/Audio/Plug-Ins/VST3/` | `~/Library/Audio/Plug-Ins/CLAP/` |
| Windows | `C:\Program Files\Common Files\VST3\` | `C:\Program Files\Common Files\CLAP\` |
| Linux | `~/.vst3/` | `~/.clap/` |

### Quick Install

```bash
cargo xtask install
```

This copies bundles to your system plugin directories.

---

## Troubleshooting

### Plugin doesn't show up in DAW

1. Verify bundles exist: `ls target/bundled/`
2. Check installation: `ls ~/Library/Audio/Plug-Ins/VST3/`
3. Rescan plugins in your DAW preferences
4. Check DAW logs for loading errors

### UI doesn't load or appears blank

1. Rebuild UI: `cd ui && npm run build && cd ..`
2. Verify `ui/dist/` has files: `ls ui/dist/`
3. Rebuild plugin: `cargo xtask bundle`

### Build errors

1. Update Rust: `rustup update stable`
2. Clean build: `cargo clean`
3. Verify prerequisites:
   - `rustc --version` (need 1.75+)
   - `node --version` (need 18+)

### Dev mode not connecting

1. Check WebSocket server is running: `lsof -i :9001`
2. Verify UI dev server is running: `lsof -i :5173`
3. Check browser console for connection errors
4. Restart: Stop servers and run `cargo xtask dev` again

---

## Next Steps

- **[Wavecraft SDK Documentation](https://github.com/RonHouben/wavecraft)** — Full SDK reference
- **[Getting Started Guide](https://github.com/RonHouben/wavecraft/blob/main/docs/guides/sdk-getting-started.md)** — Comprehensive tutorial
- **[Coding Standards](https://github.com/RonHouben/wavecraft/blob/main/docs/architecture/coding-standards.md)** — Best practices
- **[High-Level Design](https://github.com/RonHouben/wavecraft/blob/main/docs/architecture/high-level-design.md)** — Architecture overview

## Support

- **Issues:** [GitHub Issues](https://github.com/RonHouben/wavecraft/issues)
- **Discussions:** [GitHub Discussions](https://github.com/RonHouben/wavecraft/discussions)

---

## License

MIT OR Apache-2.0 (choose based on your preference)

---

**Built with [Wavecraft](https://github.com/RonHouben/wavecraft)** — Modern audio plugin framework for Rust + React
