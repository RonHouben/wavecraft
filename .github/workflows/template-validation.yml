name: Template Validation

# Runs on PRs only — main branch validation happens via PR quality gates.
# Use workflow_dispatch for manual runs (e.g., after direct commits to main).
on:
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/template-validation.yml"
      - "cli/**"
      - "sdk-template/**"
      - "dev-server/**"
      - "engine/**"
      - "ui/**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-template:
    name: Validate Generated Template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ═════════════════════════════════════════════════════════════
      # Setup
      # ═════════════════════════════════════════════════════════════

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ui/package-lock.json

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            engine
            cli

      - name: Install Linux dependencies for CLI build
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libglib2.0-dev pkg-config libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libxdo-dev libx11-xcb-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libasound2-dev
          version: 1.0

      - name: Install UI dependencies (repo)
        run: npm install
        working-directory: ui

      - name: Build UI packages (repo)
        run: npm run build:lib
        working-directory: ui

      # ═════════════════════════════════════════════════════════════
      # Build CLI
      # ═════════════════════════════════════════════════════════════

      - name: Build Wavecraft CLI
        run: cargo build --release
        working-directory: cli

      - name: Add CLI to PATH
        run: echo "${{ github.workspace }}/cli/target/release" >> $GITHUB_PATH

      # ═════════════════════════════════════════════════════════════
      # Generate Test Project
      # ═════════════════════════════════════════════════════════════

      - name: Generate test plugin (local SDK mode)
        run: |
          # Use --local-sdk to generate path dependencies pointing to local SDK crates.
          # This allows CI to validate against unreleased code (before git tags exist).
          # Must run from repo root so --local-sdk can find engine/crates
          wavecraft create test-plugin \
            --no-git \
            --local-sdk \
            --output /tmp/test-plugin

      - name: Verify generated files
        run: |
          echo "Checking generated project structure..."
          test -f /tmp/test-plugin/engine/Cargo.toml || exit 1
          test -f /tmp/test-plugin/engine/src/lib.rs || exit 1
          test -f /tmp/test-plugin/ui/package.json || exit 1
          test -f /tmp/test-plugin/ui/src/App.tsx || exit 1
          test -f /tmp/test-plugin/README.md || exit 1
          test ! -d /tmp/test-plugin/engine/xtask || (echo "❌ Deprecated engine/xtask directory should not be generated" && exit 1)
          echo "✅ All expected files present"

          # Verify local dev dependencies were applied
          echo "Checking SDK dependencies use local paths..."
          grep -q "path = " /tmp/test-plugin/engine/Cargo.toml && echo "✅ Path dependencies found" || (echo "❌ Path dependencies not found" && exit 1)

      # ═════════════════════════════════════════════════════════════
      # Validate Engine Compilation
      # ═════════════════════════════════════════════════════════════

      - name: Check generated engine code
        run: cargo check --manifest-path engine/Cargo.toml
        working-directory: /tmp/test-plugin

      - name: Verify generated engine linting (Clippy)
        run: cargo clippy --workspace --all-targets -- -D warnings
        working-directory: /tmp/test-plugin/engine

      - name: Verify generated engine formatting
        run: cargo fmt --check
        working-directory: /tmp/test-plugin/engine

      # ═════════════════════════════════════════════════════════════
      # Validate UI Compilation
      # ═════════════════════════════════════════════════════════════

      # Use `npm install` instead of `npm ci` because:
      # 1. The template's package-lock.json may reference npm packages that
      #    haven't been published yet (PR runs before merge/publish).
      # 2. Package versions may have changed since the lock file was generated.
      # 3. This mirrors real user behavior when lock files need updating.
      # The goal is validating "does the generated code compile", not
      # "is the lock file byte-for-byte correct".
      - name: Install UI dependencies
        run: npm install
        working-directory: /tmp/test-plugin/ui

      - name: Verify UI linting
        run: npm run lint
        working-directory: /tmp/test-plugin/ui

      - name: Verify UI formatting
        run: npm run format:check
        working-directory: /tmp/test-plugin/ui

      - name: TypeScript type-check
        run: npm run typecheck
        working-directory: /tmp/test-plugin/ui

      # ═════════════════════════════════════════════════════════════
      # Validate CLI Bundle Contract
      # ═════════════════════════════════════════════════════════════

      - name: Verify wavecraft bundle command surface
        run: wavecraft bundle --help | grep -q -- "--install"
        working-directory: /tmp/test-plugin

      - name: Test wavecraft bundle
        run: wavecraft bundle
        working-directory: /tmp/test-plugin

      # ═════════════════════════════════════════════════════════════
      # Validate Git-Source Startup Path (installed-CLI simulation)
      # ═════════════════════════════════════════════════════════════

      - name: Stage installed-like CLI binary
        run: |
          mkdir -p /tmp/wavecraft-installed-cli
          cp "${{ github.workspace }}/cli/target/release/wavecraft" /tmp/wavecraft-installed-cli/wavecraft
          chmod +x /tmp/wavecraft-installed-cli/wavecraft

      - name: Generate test plugin (git-source mode)
        run: |
          /tmp/wavecraft-installed-cli/wavecraft create test-plugin-git \
            --no-git \
            --output /tmp/test-plugin-git

      - name: Verify generated git-source engine dependencies
        run: |
          grep -q 'git = "https://github.com/RonHouben/wavecraft"' /tmp/test-plugin-git/engine/Cargo.toml

      - name: Apply local patch overrides for git-source simulation
        run: |
          cat <<EOF >> /tmp/test-plugin-git/Cargo.toml

          [patch."https://github.com/RonHouben/wavecraft"]
          wavecraft-nih_plug = { path = "${{ github.workspace }}/engine/crates/wavecraft-nih_plug" }
          wavecraft-dsp = { path = "${{ github.workspace }}/engine/crates/wavecraft-dsp" }
          wavecraft-dev-server = { path = "${{ github.workspace }}/dev-server" }
          EOF

      - name: Validate git-source engine compile paths
        run: |
          cargo build --manifest-path engine/Cargo.toml --lib --features _param-discovery
          cargo build --manifest-path engine/Cargo.toml --lib
        working-directory: /tmp/test-plugin-git

      - name: Install git-source UI dependencies
        run: npm install
        working-directory: /tmp/test-plugin-git/ui

      - name: Bounded wavecraft start smoke (git-source mode)
        working-directory: /tmp/test-plugin-git
        env:
          WAVECRAFT_ALLOW_NO_AUDIO: "1"
        run: |
          if [ ! -f engine/Cargo.toml ] || [ -d sdk-template ]; then
            echo "❌ Expected generated plugin root (with engine/Cargo.toml and no sdk-template/) but current directory is: $(pwd)"
            exit 1
          fi

          LOG_FILE=/tmp/test-plugin-git/start-smoke.log
          /tmp/wavecraft-installed-cli/wavecraft start --no-install --port 39091 --ui-port 39092 > "$LOG_FILE" 2>&1 &
          START_PID=$!

          READY=0
          TIMEOUT_SECS=180

          for _ in $(seq 1 "$TIMEOUT_SECS"); do
            if grep -q 'include_dir!("\$CARGO_MANIFEST_DIR/assets/ui-dist")' "$LOG_FILE"; then
              echo "❌ Regressed include_dir fallback asset panic detected"
              kill "$START_PID" 2>/dev/null || true
              wait "$START_PID" 2>/dev/null || true
              cat "$LOG_FILE"
              exit 1
            fi

            if grep -q 'No such file or directory' "$LOG_FILE" && grep -q 'assets/ui-dist' "$LOG_FILE"; then
              echo "❌ Missing fallback assets regression detected"
              kill "$START_PID" 2>/dev/null || true
              wait "$START_PID" 2>/dev/null || true
              cat "$LOG_FILE"
              exit 1
            fi

            if grep -q 'All servers running' "$LOG_FILE"; then
              READY=1
              break
            fi

            if ! kill -0 "$START_PID" 2>/dev/null; then
              echo "❌ wavecraft start exited before ready state"
              cat "$LOG_FILE"
              exit 1
            fi

            sleep 1
          done

          if [ "$READY" -ne 1 ]; then
            echo "❌ wavecraft start did not reach ready state within ${TIMEOUT_SECS}s"
            kill "$START_PID" 2>/dev/null || true
            wait "$START_PID" 2>/dev/null || true
            cat "$LOG_FILE"
            exit 1
          fi

          kill "$START_PID" 2>/dev/null || true
          wait "$START_PID" 2>/dev/null || true
          cat "$LOG_FILE"

      # ═════════════════════════════════════════════════════════════
      # Summary
      # ═════════════════════════════════════════════════════════════

      - name: Validation complete
        run: |
          echo "✅ Template validation successful!"
          echo "  - CLI generated project correctly"
          echo "  - Engine code compiles and passes linting"
          echo "  - UI code compiles and passes linting"
          echo "  - wavecraft bundle contract validated"
