# Manual Override: npm Package Release
#
# This workflow is for manual/emergency releases only.
# Normal releases happen automatically via continuous-deploy.yml on merge to main.
#
# Usage:
#   git tag npm-v0.8.0
#   git push origin npm-v0.8.0
#
name: npm Package Release (Manual)

on:
  push:
    tags:
      - 'npm-v*'
  workflow_dispatch:

jobs:
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        working-directory: ui
        run: npm ci
      
      - name: Verify version matches tag
        working-directory: ui
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/npm-v}"
          CORE_VERSION=$(node -p "require('./packages/core/package.json').version")
          COMPONENTS_VERSION=$(node -p "require('./packages/components/package.json').version")
          
          echo "Tag version: $TAG_VERSION"
          echo "Core version: $CORE_VERSION"
          echo "Components version: $COMPONENTS_VERSION"
          
          if [ "$TAG_VERSION" != "$CORE_VERSION" ]; then
            echo "❌ Version mismatch: tag=$TAG_VERSION, @wavecraft/core=$CORE_VERSION"
            exit 1
          fi
          
          if [ "$TAG_VERSION" != "$COMPONENTS_VERSION" ]; then
            echo "❌ Version mismatch: tag=$TAG_VERSION, @wavecraft/components=$COMPONENTS_VERSION"
            exit 1
          fi
          
          echo "✅ All versions match"
      
      - name: Build core package
        working-directory: ui/packages/core
        run: npm run build:lib
      
      - name: Build components package
        working-directory: ui/packages/components
        run: npm run build:lib
      
      - name: Publish @wavecraft/core
        working-directory: ui/packages/core
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public
      
      - name: Publish @wavecraft/components
        working-directory: ui/packages/components
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Wavecraft npm Packages ${{ github.ref_name }}
            
            ### Installation
            
            ```bash
            npm install @wavecraft/core @wavecraft/components
            ```
            
            ### Packages Published
            
            - [@wavecraft/core](https://www.npmjs.com/package/@wavecraft/core) — IPC bridge, hooks, utilities
            - [@wavecraft/components](https://www.npmjs.com/package/@wavecraft/components) — Pre-built React components
            
            ### Usage
            
            ```tsx
            import { useParameter, useAllParameters } from '@wavecraft/core';
            import { ParameterSlider, Meter } from '@wavecraft/components';
            ```
