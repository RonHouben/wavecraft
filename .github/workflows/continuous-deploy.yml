name: Continuous Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force-publish-cli:
        description: 'Force publish CLI (ignore change detection)'
        type: boolean
        default: false
      force-publish-engine:
        description: 'Force publish engine crates (ignore change detection)'
        type: boolean
        default: false
      force-publish-dev-server:
        description: 'Force publish dev-server (ignore change detection)'
        type: boolean
        default: false
      force-publish-npm-core:
        description: 'Force publish @wavecraft/core (ignore change detection)'
        type: boolean
        default: false
      force-publish-npm-components:
        description: 'Force publish @wavecraft/components (ignore change detection)'
        type: boolean
        default: false

concurrency:
  group: continuous-deploy
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Job 1: Detect which packages changed
  # ============================================================================
  detect-changes:
    runs-on: ubuntu-latest
    # Skip if the triggering commit was made by the CI bot (auto-bump) to prevent infinite loops
    if: github.event.head_commit.author.name != 'github-actions[bot]'
    outputs:
      cli: ${{ steps.filter.outputs.cli == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-cli) }}
      engine: ${{ steps.filter.outputs.engine == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-engine) }}
      npm-core: ${{ steps.filter.outputs.npm-core == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-npm-core) }}
      npm-components: ${{ steps.filter.outputs.npm-components == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-npm-components) }}
      dev-server: ${{ steps.filter.outputs.dev-server == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-dev-server) }}
      any_sdk_changed: ${{ steps.aggregate.outputs.any_sdk_changed }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cli:
              - 'cli/src/**'
              - 'cli/Cargo.toml'
              - 'cli/sdk-templates/**'
            engine:
              - 'engine/crates/wavecraft-core/**'
              - 'engine/crates/wavecraft-dsp/**'
              - 'engine/crates/wavecraft-protocol/**'
              - 'engine/crates/wavecraft-bridge/**'
              - 'engine/crates/wavecraft-metering/**'
              - 'engine/crates/wavecraft-macros/**'
              - 'engine/Cargo.toml'
            dev-server:
              - 'dev-server/**'
            npm-core:
              - 'ui/packages/core/**'
            npm-components:
              - 'ui/packages/components/**'

      - name: Compute aggregate flag
        id: aggregate
        run: |
          if [[ "${{ steps.filter.outputs.cli }}" == "true" || \
                "${{ steps.filter.outputs.engine }}" == "true" || \
                "${{ steps.filter.outputs.dev-server }}" == "true" || \
                "${{ steps.filter.outputs.npm-core }}" == "true" || \
                "${{ steps.filter.outputs.npm-components }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-cli }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-engine }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-dev-server }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-npm-core }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-npm-components }}" == "true" ]]; then
            echo "any_sdk_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_sdk_changed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Job 2: Publish CLI to crates.io
  # ============================================================================
  publish-cli:
    needs:
      [detect-changes, publish-engine, publish-dev-server, publish-npm-core, publish-npm-components]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.any_sdk_changed == 'true' &&
      (needs.publish-engine.result == 'success' || needs.publish-engine.result == 'skipped') &&
      (needs.publish-dev-server.result == 'success' || needs.publish-dev-server.result == 'skipped') &&
      (needs.publish-npm-core.result == 'success' || needs.publish-npm-core.result == 'skipped') &&
      (needs.publish-npm-components.result == 'success' || needs.publish-npm-components.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for crates.io trusted publishing (OIDC)
      contents: write # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for git tagging

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libasound2-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cli

      - name: Validate CLI dependencies
        working-directory: engine
        run: cargo xtask validate-cli-deps --check-registry

      - name: Query registry version
        id: registry
        run: |
          # Query with explicit HTTP status check
          HTTP_CODE=$(curl -s -o /tmp/crate-index.txt -w "%{http_code}" \
            "https://index.crates.io/wa/ve/wavecraft")
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "⚠️  crates.io index returned HTTP $HTTP_CODE"
            echo "registry_available=false" >> $GITHUB_OUTPUT
            echo "published=unknown" >> $GITHUB_OUTPUT
          else
            PUBLISHED=$(tail -1 /tmp/crate-index.txt | jq -r '.vers' 2>/dev/null)
            if [ -z "$PUBLISHED" ] || [ "$PUBLISHED" = "null" ]; then
              echo "⚠️  Failed to parse version from crates.io index"
              echo "registry_available=false" >> $GITHUB_OUTPUT
              echo "published=unknown" >> $GITHUB_OUTPUT
            else
              echo "✅ Latest on crates.io: $PUBLISHED"
              echo "registry_available=true" >> $GITHUB_OUTPUT
              echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Determine publish version
        id: version
        env:
          IS_FORCE_PUBLISH: ${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-cli }}
        run: |
          CURRENT=$(cargo metadata --manifest-path cli/Cargo.toml --no-deps --format-version 1 | jq -r '.packages[0].version')
          PUBLISHED="${{ steps.registry.outputs.published }}"
          REGISTRY_OK="${{ steps.registry.outputs.registry_available }}"
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Local version:     $CURRENT"
          echo "Published version: $PUBLISHED"
          echo "Registry OK:       $REGISTRY_OK"
          echo "Force publish:     $IS_FORCE_PUBLISH"
          
          # Decision logic
          if [ "$REGISTRY_OK" != "true" ]; then
            # Registry unavailable — cannot determine if bump needed
            if [ "$IS_FORCE_PUBLISH" = "true" ]; then
              echo "❌ Cannot force-publish: registry query failed (cannot determine safe bump target)"
              exit 1
            else
              echo "⚠️  Registry unavailable, but this is not a force-publish. Skipping."
              echo "action=skip" >> $GITHUB_OUTPUT
            fi
          elif [ "$IS_FORCE_PUBLISH" = "true" ]; then
            # Force-publish: ALWAYS bump, regardless of current vs published
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Force-publish requested — will auto-bump from $PUBLISHED"
          elif [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
            # Local version is ahead of published — publish as-is
            echo "action=publish" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
          elif [ "$CURRENT" = "$PUBLISHED" ]; then
            # Same version as published — auto-bump
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT equals published — will auto-bump"
          else
            # Local is behind published (shouldn't happen normally)
            echo "❌ Local version $CURRENT is BEHIND published $PUBLISHED — manual intervention required"
            exit 1
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.action == 'bump'
        run: |
          PUBLISHED=${{ steps.version.outputs.published }}
          NEW=$(npx --yes semver "$PUBLISHED" -i patch)
          sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$NEW"'"/}' cli/Cargo.toml
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped CLI to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cli/Cargo.toml
          git commit -m "chore: bump wavecraft CLI to ${{ steps.bump.outputs.version }} [auto-bump]"
          # NOTE: No push to main — branch protection prevents direct pushes.
          # The version bump exists locally for cargo publish and tagging only.

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify version not already published
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Check if this exact version exists on crates.io
          if curl -s "https://index.crates.io/wa/ve/wavecraft" \
            | grep -q "\"vers\":\"$VERSION\""; then
            echo "❌ Version $VERSION already exists on crates.io!"
            echo "This means the auto-bump logic failed to produce a new version."
            exit 1
          fi
          echo "✅ Version $VERSION is not yet on crates.io — safe to publish"

      - name: Verify publishability (dry-run)
        working-directory: cli
        run: cargo publish --dry-run

      - name: Authenticate with crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        working-directory: cli
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: cargo publish

      - name: Create and push git tag
        run: |
          git tag "wavecraft-cli-v${{ steps.final.outputs.version }}"
          git push origin "wavecraft-cli-v${{ steps.final.outputs.version }}"

  # ============================================================================
  # Job 3: Publish engine crates to crates.io
  # ============================================================================
  publish-engine:
    needs: detect-changes
    if: needs.detect-changes.outputs.engine == 'true' || needs.detect-changes.outputs.cli == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for crates.io trusted publishing (OIDC)
      contents: write # For version bump commits and git tags
    outputs:
      version: ${{ steps.final.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for cargo-workspaces version detection

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: engine

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Query registry version
        id: registry
        run: |
          # Query with explicit HTTP status check
          HTTP_CODE=$(curl -s -o /tmp/crate-index.txt -w "%{http_code}" \
            "https://index.crates.io/wa/ve/wavecraft-core")
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "⚠️  crates.io index returned HTTP $HTTP_CODE"
            echo "registry_available=false" >> $GITHUB_OUTPUT
            echo "published=unknown" >> $GITHUB_OUTPUT
          else
            PUBLISHED=$(tail -1 /tmp/crate-index.txt | jq -r '.vers' 2>/dev/null)
            if [ -z "$PUBLISHED" ] || [ "$PUBLISHED" = "null" ]; then
              echo "⚠️  Failed to parse version from crates.io index"
              echo "registry_available=false" >> $GITHUB_OUTPUT
              echo "published=unknown" >> $GITHUB_OUTPUT
            else
              echo "✅ Latest on crates.io: $PUBLISHED"
              echo "registry_available=true" >> $GITHUB_OUTPUT
              echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Determine publish version
        id: version
        env:
          IS_FORCE_PUBLISH: ${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-engine }}
        run: |
          CURRENT=$(grep -m1 'version = "' engine/Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          PUBLISHED="${{ steps.registry.outputs.published }}"
          REGISTRY_OK="${{ steps.registry.outputs.registry_available }}"
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Local version:     $CURRENT"
          echo "Published version: $PUBLISHED"
          echo "Registry OK:       $REGISTRY_OK"
          echo "Force publish:     $IS_FORCE_PUBLISH"
          
          # Decision logic
          if [ "$REGISTRY_OK" != "true" ]; then
            # Registry unavailable — cannot determine if bump needed
            if [ "$IS_FORCE_PUBLISH" = "true" ]; then
              echo "❌ Cannot force-publish: registry query failed (cannot determine safe bump target)"
              exit 1
            else
              echo "⚠️  Registry unavailable, but this is not a force-publish. Skipping."
              echo "action=skip" >> $GITHUB_OUTPUT
            fi
          elif [ "$IS_FORCE_PUBLISH" = "true" ]; then
            # Force-publish: ALWAYS bump, regardless of current vs published
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Force-publish requested — will auto-bump from $PUBLISHED"
          elif [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
            # Local version is ahead of published — publish as-is
            echo "action=publish" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
          elif [ "$CURRENT" = "$PUBLISHED" ]; then
            # Same version as published — auto-bump
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT equals published — will auto-bump"
          else
            # Local is behind published (shouldn't happen normally)
            echo "❌ Local version $CURRENT is BEHIND published $PUBLISHED — manual intervention required"
            exit 1
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.action == 'bump'
        working-directory: engine
        run: |
          PUBLISHED="${{ steps.registry.outputs.published }}"
          NEW=$(npx --yes semver "$PUBLISHED" -i patch)
          echo "Bumping engine workspace from ${{ steps.version.outputs.current }} to $NEW"
          
          cargo ws version custom "$NEW" --yes --no-git --allow-branch main
          
          # Verify the bump actually changed files
          if git diff --quiet; then
            echo "❌ cargo ws version custom did not modify any files"
            exit 1
          fi
          
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "✅ Auto-bumped engine crates to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.version != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add engine/
          git commit -m "chore: bump engine crates to ${{ steps.bump.outputs.version }} [auto-bump]"
          echo "✅ Committed version bump"

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify version not already published
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Check if this exact version exists on crates.io
          if curl -s "https://index.crates.io/wa/ve/wavecraft-core" \
            | grep -q "\"vers\":\"$VERSION\""; then
            echo "❌ Version $VERSION already exists on crates.io!"
            echo "This means the auto-bump logic failed to produce a new version."
            exit 1
          fi
          echo "✅ Version $VERSION is not yet on crates.io — safe to publish"

      - name: Verify publishability (dry-run)
        working-directory: engine
        run: |
          cargo ws publish \
            --yes \
            --no-git-push \
            --allow-branch main \
            --from-git \
            --dry-run

      - name: Authenticate with crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        working-directory: engine
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: |
          cargo ws publish \
            --yes \
            --no-git-push \
            --allow-branch main \
            --from-git

      - name: Push tags only
        run: git push origin --tags

  # ============================================================================
  # Job 3b: Publish dev-server crate to crates.io
  # ============================================================================
  publish-dev-server:
    needs: [detect-changes, publish-engine]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.dev-server == 'true' &&
      (needs.publish-engine.result == 'success' || needs.publish-engine.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    outputs:
      version: ${{ steps.final.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libasound2-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: dev-server

      - name: Sync version with engine (if engine published)
        if: needs.publish-engine.outputs.version != ''
        run: |
          TARGET="${{ needs.publish-engine.outputs.version }}"
          echo "Syncing dev-server to engine version $TARGET"
          
          # ── 1. Update dev-server's own version and dependency versions ──
          sed -i 's/^version = ".*"/version = "'"$TARGET"'"/' dev-server/Cargo.toml
          sed -i 's/\(wavecraft-bridge = { .*version = \)"[^"]*"/\1"'"$TARGET"'"/' dev-server/Cargo.toml
          sed -i 's/\(wavecraft-protocol = { .*version = \)"[^"]*"/\1"'"$TARGET"'"/' dev-server/Cargo.toml
          
          # ── 2. Replay the engine version bump locally ──
          # publish-engine bumped these in its (now-gone) workspace.
          # We must match them so path dep resolution succeeds.
          
          # 2a. Engine workspace package version
          sed -i '/^\[workspace\.package\]/,/^\[/{s/^version = ".*"/version = "'"$TARGET"'"/}' engine/Cargo.toml
          
          # 2b. Engine workspace dependency version specifiers
          sed -i 's/\(wavecraft-[a-z_]* = { .*version = \)"[^"]*"/\1"'"$TARGET"'"/' engine/Cargo.toml
          
          # 2c. Individual crate package versions
          for crate_dir in engine/crates/wavecraft-*/; do
            if [ -f "$crate_dir/Cargo.toml" ]; then
              sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$TARGET"'"/}' "$crate_dir/Cargo.toml"
            fi
          done
          
          # ── 3. Verify ──
          echo "=== dev-server/Cargo.toml ==="
          head -3 dev-server/Cargo.toml
          grep -E 'wavecraft-(bridge|protocol)' dev-server/Cargo.toml
          echo "=== engine workspace version ==="
          sed -n '/\[workspace\.package\]/,/^\[/{/version/p}' engine/Cargo.toml
          echo "=== engine crate versions ==="
          for f in engine/crates/wavecraft-*/Cargo.toml; do
            echo "  $(dirname $f | xargs basename): $(grep -m1 'version = "' $f)"
          done

      - name: Wait for engine crates on crates.io
        if: needs.publish-engine.outputs.version != ''
        run: |
          TARGET="${{ needs.publish-engine.outputs.version }}"
          echo "Waiting for wavecraft-bridge $TARGET and wavecraft-protocol $TARGET on crates.io..."
          
          wait_for_crate() {
            local CRATE=$1
            local VERSION=$2
            local MAX_ATTEMPTS=30
            local DELAY=10
            
            for i in $(seq 1 $MAX_ATTEMPTS); do
              # Query the sparse index directly (bypasses CDN caching)
              LATEST=$(curl -s "https://index.crates.io/wa/ve/$CRATE" \
                | grep "\"vers\":\"$VERSION\"" > /dev/null 2>&1 && echo "$VERSION" || echo "not-found")
              
              if [ "$LATEST" = "$VERSION" ]; then
                echo "✅ $CRATE $VERSION available on crates.io (attempt $i)"
                return 0
              fi
              
              echo "⏳ $CRATE $VERSION not yet in index (attempt $i/$MAX_ATTEMPTS, waiting ${DELAY}s...)"
              sleep $DELAY
            done
            
            echo "❌ Timed out waiting for $CRATE $VERSION after $((MAX_ATTEMPTS * DELAY))s"
            return 1
          }
          
          wait_for_crate "wavecraft-protocol" "$TARGET"
          wait_for_crate "wavecraft-bridge" "$TARGET"
          
          # Force Cargo to refresh its index cache
          cargo search wavecraft-bridge --limit 1 > /dev/null 2>&1 || true

      - name: Query registry version
        id: registry
        run: |
          # Query with explicit HTTP status check
          HTTP_CODE=$(curl -s -o /tmp/crate-index.txt -w "%{http_code}" \
            "https://index.crates.io/wa/ve/wavecraft-dev-server")
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "⚠️  crates.io index returned HTTP $HTTP_CODE"
            echo "registry_available=false" >> $GITHUB_OUTPUT
            echo "published=unknown" >> $GITHUB_OUTPUT
          else
            PUBLISHED=$(tail -1 /tmp/crate-index.txt | jq -r '.vers' 2>/dev/null)
            if [ -z "$PUBLISHED" ] || [ "$PUBLISHED" = "null" ]; then
              echo "⚠️  Failed to parse version from crates.io index"
              echo "registry_available=false" >> $GITHUB_OUTPUT
              echo "published=unknown" >> $GITHUB_OUTPUT
            else
              echo "✅ Latest on crates.io: $PUBLISHED"
              echo "registry_available=true" >> $GITHUB_OUTPUT
              echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Determine publish version
        id: version
        env:
          IS_FORCE_PUBLISH: ${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-dev-server }}
        run: |
          CURRENT=$(grep -m1 'version = "' dev-server/Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          PUBLISHED="${{ steps.registry.outputs.published }}"
          REGISTRY_OK="${{ steps.registry.outputs.registry_available }}"
          
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Local version:     $CURRENT"
          echo "Published version: $PUBLISHED"
          echo "Registry OK:       $REGISTRY_OK"
          echo "Force publish:     $IS_FORCE_PUBLISH"
          
          # Decision logic
          if [ "$REGISTRY_OK" != "true" ]; then
            # Registry unavailable — cannot determine if bump needed
            if [ "$IS_FORCE_PUBLISH" = "true" ]; then
              echo "❌ Cannot force-publish: registry query failed (cannot determine safe bump target)"
              exit 1
            else
              echo "⚠️  Registry unavailable, but this is not a force-publish. Skipping."
              echo "action=skip" >> $GITHUB_OUTPUT
            fi
          elif [ "$IS_FORCE_PUBLISH" = "true" ]; then
            # Force-publish: ALWAYS bump, regardless of current vs published
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Force-publish requested — will auto-bump from $PUBLISHED"
          elif [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
            # Local version is ahead of published — publish as-is
            echo "action=publish" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
          elif [ "$CURRENT" = "$PUBLISHED" ]; then
            # Same version as published — auto-bump
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT equals published — will auto-bump"
          else
            # Local is behind published (shouldn't happen normally)
            echo "❌ Local version $CURRENT is BEHIND published $PUBLISHED — manual intervention required"
            exit 1
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.action == 'bump'
        run: |
          PUBLISHED=${{ steps.version.outputs.published }}
          NEW=$(npx --yes semver "$PUBLISHED" -i patch)
          sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$NEW"'"/}' dev-server/Cargo.toml
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped dev-server to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dev-server/Cargo.toml
          git commit -m "chore: bump wavecraft-dev-server to ${{ steps.bump.outputs.version }} [auto-bump]"

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify version not already published
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Check if this exact version exists on crates.io
          if curl -s "https://index.crates.io/wa/ve/wavecraft-dev-server" \
            | grep -q "\"vers\":\"$VERSION\""; then
            echo "❌ Version $VERSION already exists on crates.io!"
            echo "This means the auto-bump logic failed to produce a new version."
            exit 1
          fi
          echo "✅ Version $VERSION is not yet on crates.io — safe to publish"

      - name: Verify publishability (dry-run)
        working-directory: dev-server
        run: cargo publish --dry-run

      - name: Authenticate with crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        working-directory: dev-server
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: |
          MAX_ATTEMPTS=3
          DELAY=30
          
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Publish attempt $i/$MAX_ATTEMPTS..."
            if cargo publish; then
              echo "✅ Published successfully"
              exit 0
            fi
            
            if [ "$i" -lt "$MAX_ATTEMPTS" ]; then
              echo "⏳ Publish failed, retrying in ${DELAY}s..."
              sleep $DELAY
              DELAY=$((DELAY * 2))
            fi
          done
          
          echo "❌ All publish attempts failed"
          exit 1

      - name: Create and push git tag
        run: |
          git tag "wavecraft-dev-server-v${{ steps.final.outputs.version }}"
          git push origin "wavecraft-dev-server-v${{ steps.final.outputs.version }}"

  # ============================================================================
  # Job 4: Publish @wavecraft/core to npm
  # ============================================================================
  publish-npm-core:
    needs: detect-changes
    if: needs.detect-changes.outputs.npm-core == 'true'
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
    permissions:
      id-token: write # Required for npm OIDC trusted publishing + provenance
      contents: write # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for git tagging

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: "@wavecraft"
          always-auth: false

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Clear npm auth token
        run: |
          npm config delete //registry.npmjs.org/:_authToken || true
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Determine publish version
        id: version
        working-directory: ui/packages/core
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          LATEST=$(npm view @wavecraft/core version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if npx --yes semver "$LOCAL" -r ">$LATEST" > /dev/null 2>&1; then
            echo "version=$LOCAL" >> $GITHUB_OUTPUT
            echo "Publishing local version: $LOCAL (ahead of npm: $LATEST)"
          else
            echo "Auto-bumping: local $LOCAL is not ahead of npm $LATEST"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.version == ''
        working-directory: ui/packages/core
        run: |
          LATEST=${{ steps.version.outputs.latest }}
          NEW=$(npx --yes semver "$LATEST" -i patch)
          npm version "$NEW" --no-git-tag-version
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped @wavecraft/core to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ui/packages/core/package.json
          git commit -m "chore: bump @wavecraft/core to ${{ steps.bump.outputs.version }} [auto-bump]"
          # NOTE: No push to main — branch protection prevents direct pushes.
          # The version bump exists locally for npm publish and tagging only.

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build package
        working-directory: ui/packages/core
        run: npm run build:lib

      - name: Verify publishability (dry-run)
        working-directory: ui/packages/core
        run: npm publish --access public --dry-run

      - name: Publish to npm
        working-directory: ui/packages/core
        env:
          NPM_CONFIG_PROVENANCE: true
        run: npm publish --access public --provenance

      - name: Create and push git tag
        run: |
          git tag "@wavecraft/core-v${{ steps.final.outputs.version }}"
          git push origin "@wavecraft/core-v${{ steps.final.outputs.version }}"

  # ============================================================================
  # Job 5: Publish @wavecraft/components to npm
  # ============================================================================
  publish-npm-components:
    needs: [detect-changes, publish-npm-core]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.npm-components == 'true' &&
      (needs.publish-npm-core.result == 'success' || needs.publish-npm-core.result == 'skipped' ||
       (needs.publish-npm-core.result == 'failure' && needs.detect-changes.outputs.npm-core != 'true'))
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
    permissions:
      id-token: write # Required for npm OIDC trusted publishing + provenance
      contents: write # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: "@wavecraft"
          always-auth: false

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Clear npm auth token
        run: |
          npm config delete //registry.npmjs.org/:_authToken || true
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Determine publish version
        id: version
        working-directory: ui/packages/components
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          LATEST=$(npm view @wavecraft/components version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if npx --yes semver "$LOCAL" -r ">$LATEST" > /dev/null 2>&1; then
            echo "version=$LOCAL" >> $GITHUB_OUTPUT
            echo "Publishing local version: $LOCAL (ahead of npm: $LATEST)"
          else
            echo "Auto-bumping: local $LOCAL is not ahead of npm $LATEST"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.version == ''
        working-directory: ui/packages/components
        run: |
          LATEST=${{ steps.version.outputs.latest }}
          NEW=$(npx --yes semver "$LATEST" -i patch)
          npm version "$NEW" --no-git-tag-version
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped @wavecraft/components to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ui/packages/components/package.json
          git commit -m "chore: bump @wavecraft/components to ${{ steps.bump.outputs.version }} [auto-bump]"
          # NOTE: No push to main — branch protection prevents direct pushes.
          # The version bump exists locally for npm publish and tagging only.

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build package
        working-directory: ui/packages/components
        run: npm run build:lib

      - name: Verify publishability (dry-run)
        working-directory: ui/packages/components
        run: npm publish --access public --dry-run

      - name: Publish to npm
        working-directory: ui/packages/components
        env:
          NPM_CONFIG_PROVENANCE: true
        run: npm publish --access public --provenance

      - name: Create and push git tag
        run: |
          git tag "@wavecraft/components-v${{ steps.final.outputs.version }}"
          git push origin "@wavecraft/components-v${{ steps.final.outputs.version }}"
