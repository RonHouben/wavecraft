name: Continuous Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: continuous-deploy
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Job 1: Detect which packages changed
  # ============================================================================
  detect-changes:
    runs-on: ubuntu-latest
    # Skip if the triggering commit was made by the CI bot (auto-bump) to prevent infinite loops
    if: github.event.head_commit.author.name != 'github-actions[bot]'
    outputs:
      cli: ${{ steps.filter.outputs.cli }}
      engine: ${{ steps.filter.outputs.engine }}
      npm-core: ${{ steps.filter.outputs.npm-core }}
      npm-components: ${{ steps.filter.outputs.npm-components }}
      any_sdk_changed: ${{ steps.aggregate.outputs.any_sdk_changed }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cli:
              - 'cli/src/**'
              - 'cli/Cargo.toml'
              - 'cli/sdk-templates/**'
            engine:
              - 'engine/crates/wavecraft-core/**'
              - 'engine/crates/wavecraft-dsp/**'
              - 'engine/crates/wavecraft-protocol/**'
              - 'engine/crates/wavecraft-bridge/**'
              - 'engine/crates/wavecraft-metering/**'
              - 'engine/crates/wavecraft-macros/**'
            npm-core:
              - 'ui/packages/core/**'
            npm-components:
              - 'ui/packages/components/**'

      - name: Compute aggregate flag
        id: aggregate
        run: |
          if [[ "${{ steps.filter.outputs.cli }}" == "true" || \
                "${{ steps.filter.outputs.engine }}" == "true" || \
                "${{ steps.filter.outputs.npm-core }}" == "true" || \
                "${{ steps.filter.outputs.npm-components }}" == "true" ]]; then
            echo "any_sdk_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_sdk_changed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Job 2: Publish CLI to crates.io
  # ============================================================================
  publish-cli:
    needs: [detect-changes, publish-engine, publish-npm-core, publish-npm-components]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.any_sdk_changed == 'true' &&
      (needs.publish-engine.result == 'success' || needs.publish-engine.result == 'skipped') &&
      (needs.publish-npm-core.result == 'success' || needs.publish-npm-core.result == 'skipped') &&
      (needs.publish-npm-components.result == 'success' || needs.publish-npm-components.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for crates.io trusted publishing (OIDC)
      contents: write  # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for git tagging
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libasound2-dev
      
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cli

      - name: Validate CLI dependencies
        working-directory: engine
        run: cargo xtask validate-cli-deps
      
      - name: Determine publish version
        id: version
        run: |
          CURRENT=$(cargo metadata --manifest-path cli/Cargo.toml --no-deps --format-version 1 | jq -r '.packages[0].version')
          PUBLISHED=$(curl -s "https://index.crates.io/wa/ve/wavecraft" | tail -1 | jq -r '.vers' 2>/dev/null || echo "0.0.0")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "published=$PUBLISHED" >> $GITHUB_OUTPUT

          if [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ] && [ "$CURRENT" != "$PUBLISHED" ]; then
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Publishing current version: $CURRENT (latest on crates.io: $PUBLISHED)"
          else
            echo "Auto-bumping: local $CURRENT is not ahead of crates.io $PUBLISHED"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.version == ''
        run: |
          PUBLISHED=${{ steps.version.outputs.published }}
          NEW=$(npx --yes semver "$PUBLISHED" -i patch)
          sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$NEW"'"/}' cli/Cargo.toml
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped CLI to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cli/Cargo.toml
          git commit -m "chore: bump wavecraft CLI to ${{ steps.bump.outputs.version }} [auto-bump]"
          # NOTE: No push to main — branch protection prevents direct pushes.
          # The version bump exists locally for cargo publish and tagging only.

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify publishability (dry-run)
        working-directory: cli
        run: cargo publish --dry-run
      
      - name: Authenticate with crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        working-directory: cli
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: cargo publish

      - name: Create and push git tag
        run: |
          git tag "wavecraft-cli-v${{ steps.final.outputs.version }}"
          git push origin "wavecraft-cli-v${{ steps.final.outputs.version }}"

  # ============================================================================
  # Job 3: Publish engine crates to crates.io
  # ============================================================================
  publish-engine:
    needs: detect-changes
    if: needs.detect-changes.outputs.engine == 'true' || needs.detect-changes.outputs.cli == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for crates.io trusted publishing (OIDC)
      contents: write  # For version bump commits and git tags
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for cargo-workspaces version detection

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: engine

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify publishability (dry-run)
        working-directory: engine
        run: |
          cargo ws publish \
            --from-git \
            --dry-run \
            --yes \
            --no-git-push \
            --allow-branch main

      - name: Authenticate with crates.io (OIDC)
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io (with version bump and tags)
        working-directory: engine
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: |
          cargo ws publish \
            --from-git \
            --yes \
            --no-git-push \
            --allow-branch main

      - name: Push tags only
        run: |
          # Push tags created by cargo-workspaces without pushing commits to main.
          # Tags are not subject to branch protection rules.
          git push origin --tags

  # ============================================================================
  # Job 4: Publish @wavecraft/core to npm
  # ============================================================================
  publish-npm-core:
    needs: detect-changes
    if: needs.detect-changes.outputs.npm-core == 'true'
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
    permissions:
      id-token: write  # Required for npm OIDC trusted publishing + provenance
      contents: write  # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for git tagging
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          scope: '@wavecraft'
          always-auth: false

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Clear npm auth token
        run: |
          npm config delete //registry.npmjs.org/:_authToken || true
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi
      
      - name: Install dependencies
        working-directory: ui
        run: npm ci
      
      - name: Determine publish version
        id: version
        working-directory: ui/packages/core
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          LATEST=$(npm view @wavecraft/core version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if npx --yes semver "$LOCAL" -r ">$LATEST" > /dev/null 2>&1; then
            echo "version=$LOCAL" >> $GITHUB_OUTPUT
            echo "Publishing local version: $LOCAL (ahead of npm: $LATEST)"
          else
            echo "Auto-bumping: local $LOCAL is not ahead of npm $LATEST"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.version == ''
        working-directory: ui/packages/core
        run: |
          LATEST=${{ steps.version.outputs.latest }}
          NEW=$(npx --yes semver "$LATEST" -i patch)
          npm version "$NEW" --no-git-tag-version
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped @wavecraft/core to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ui/packages/core/package.json
          git commit -m "chore: bump @wavecraft/core to ${{ steps.bump.outputs.version }} [auto-bump]"
          # NOTE: No push to main — branch protection prevents direct pushes.
          # The version bump exists locally for npm publish and tagging only.

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build package
        working-directory: ui/packages/core
        run: npm run build:lib
      
      - name: Verify publishability (dry-run)
        working-directory: ui/packages/core
        run: npm publish --access public --dry-run
      
      - name: Publish to npm
        working-directory: ui/packages/core
        env:
          NPM_CONFIG_PROVENANCE: true
        run: npm publish --access public --provenance

      - name: Create and push git tag
        run: |
          git tag "@wavecraft/core-v${{ steps.final.outputs.version }}"
          git push origin "@wavecraft/core-v${{ steps.final.outputs.version }}"

  # ============================================================================
  # Job 5: Publish @wavecraft/components to npm
  # ============================================================================
  publish-npm-components:
    needs: [detect-changes, publish-npm-core]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.npm-components == 'true' &&
      (needs.publish-npm-core.result == 'success' || needs.publish-npm-core.result == 'skipped' ||
       (needs.publish-npm-core.result == 'failure' && needs.detect-changes.outputs.npm-core != 'true'))
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
    permissions:
      id-token: write  # Required for npm OIDC trusted publishing + provenance
      contents: write  # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          scope: '@wavecraft'
          always-auth: false

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Clear npm auth token
        run: |
          npm config delete //registry.npmjs.org/:_authToken || true
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi
      
      - name: Install dependencies
        working-directory: ui
        run: npm ci
      
      - name: Determine publish version
        id: version
        working-directory: ui/packages/components
        run: |
          LOCAL=$(node -p "require('./package.json').version")
          LATEST=$(npm view @wavecraft/components version 2>/dev/null || echo "0.0.0")
          echo "local=$LOCAL" >> $GITHUB_OUTPUT
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          if npx --yes semver "$LOCAL" -r ">$LATEST" > /dev/null 2>&1; then
            echo "version=$LOCAL" >> $GITHUB_OUTPUT
            echo "Publishing local version: $LOCAL (ahead of npm: $LATEST)"
          else
            echo "Auto-bumping: local $LOCAL is not ahead of npm $LATEST"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.version == ''
        working-directory: ui/packages/components
        run: |
          LATEST=${{ steps.version.outputs.latest }}
          NEW=$(npx --yes semver "$LATEST" -i patch)
          npm version "$NEW" --no-git-tag-version
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped @wavecraft/components to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ui/packages/components/package.json
          git commit -m "chore: bump @wavecraft/components to ${{ steps.bump.outputs.version }} [auto-bump]"
          # NOTE: No push to main — branch protection prevents direct pushes.
          # The version bump exists locally for npm publish and tagging only.

      - name: Set final version
        id: final
        run: |
          VERSION="${{ steps.version.outputs.version }}${{ steps.bump.outputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Build package
        working-directory: ui/packages/components
        run: npm run build:lib
      
      - name: Verify publishability (dry-run)
        working-directory: ui/packages/components
        run: npm publish --access public --dry-run
      
      - name: Publish to npm
        working-directory: ui/packages/components
        env:
          NPM_CONFIG_PROVENANCE: true
        run: npm publish --access public --provenance

      - name: Create and push git tag
        run: |
          git tag "@wavecraft/components-v${{ steps.final.outputs.version }}"
          git push origin "@wavecraft/components-v${{ steps.final.outputs.version }}"
