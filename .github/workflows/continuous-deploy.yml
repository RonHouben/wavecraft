name: Continuous Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force-publish-cli:
        description: "Force publish CLI (ignore change detection)"
        type: boolean
        default: false
      force-publish-engine:
        description: "Force publish engine crates (ignore change detection)"
        type: boolean
        default: false
      force-publish-dev-server:
        description: "Force publish dev-server (ignore change detection)"
        type: boolean
        default: false
      force-publish-npm-cohort:
        description: "Force publish npm cohort (@wavecraft/core + @wavecraft/components) (ignore change detection)"
        type: boolean
        default: false

concurrency:
  group: continuous-deploy
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Job 1: Detect which packages changed
  # ============================================================================
  detect-changes:
    runs-on: ubuntu-latest
    # Skip if the triggering commit was made by the CI bot (auto-bump) to prevent infinite loops
    if: github.event.head_commit.author.name != 'github-actions[bot]'
    outputs:
      cli: ${{ steps.filter.outputs.cli == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-cli) }}
      engine: ${{ steps.filter.outputs.engine == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-engine) }}
      npm-core: ${{ steps.filter.outputs.npm-core == 'true' }}
      npm-components: ${{ steps.filter.outputs.npm-components == 'true' }}
      npm-cohort: ${{
        steps.filter.outputs.npm-core == 'true' ||
        steps.filter.outputs.npm-components == 'true' ||
        (github.event_name == 'workflow_dispatch' && inputs.force-publish-npm-cohort)
        }}
      dev-server: ${{ steps.filter.outputs.dev-server == 'true' || (github.event_name == 'workflow_dispatch' && inputs.force-publish-dev-server) }}
      any_sdk_changed: ${{ steps.aggregate.outputs.any_sdk_changed }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cli:
              - 'cli/src/**'
              - 'cli/Cargo.toml'
              - 'sdk-template/**'
            engine:
              - 'engine/crates/wavecraft-core/**'
              - 'engine/crates/wavecraft-dsp/**'
              - 'engine/crates/wavecraft-protocol/**'
              - 'engine/crates/wavecraft-bridge/**'
              - 'engine/crates/wavecraft-metering/**'
              - 'engine/crates/wavecraft-macros/**'
              - 'engine/Cargo.toml'
            dev-server:
              - 'dev-server/**'
            npm-core:
              - 'ui/packages/core/**'
            npm-components:
              - 'ui/packages/components/**'

      - name: Compute aggregate flag
        id: aggregate
        run: |
          if [[ "${{ steps.filter.outputs.cli }}" == "true" || \
                "${{ steps.filter.outputs.engine }}" == "true" || \
                "${{ steps.filter.outputs.dev-server }}" == "true" || \
                "${{ steps.filter.outputs.npm-core }}" == "true" || \
                "${{ steps.filter.outputs.npm-components }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-cli }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-engine }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-dev-server }}" == "true" || \
                "${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-npm-cohort }}" == "true" ]]; then
            echo "any_sdk_changed=true" >> $GITHUB_OUTPUT
          else
            echo "any_sdk_changed=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # Job 2: Publish CLI to crates.io
  # ============================================================================
  publish-cli:
    needs:
      [
        detect-changes,
        publish-engine,
        publish-dev-server,
        publish-npm-core,
        publish-npm-components,
      ]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.any_sdk_changed == 'true' &&
      (
        (needs.detect-changes.outputs.engine != 'true' && needs.detect-changes.outputs.cli != 'true') ||
        needs.publish-engine.outputs.version != ''
      ) &&
      (needs.publish-engine.result == 'success' || needs.publish-engine.result == 'skipped') &&
      (needs.publish-dev-server.result == 'success' || needs.publish-dev-server.result == 'skipped') &&
      (needs.publish-npm-core.result == 'success' || needs.publish-npm-core.result == 'skipped') &&
      (needs.publish-npm-components.result == 'success' || needs.publish-npm-components.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for crates.io trusted publishing (OIDC)
      contents: write # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for git tagging

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev \
            libasound2-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: cli

      - name: Wait for published crates on crates.io
        run: |
          echo "Waiting for crates.io propagation..."

          # Wait for dev-server if it was published in this workflow
          DEV_SERVER_VERSION="${{ needs.publish-dev-server.outputs.version }}"
          if [ -n "$DEV_SERVER_VERSION" ]; then
            bash scripts/ci/wait-for-crate.sh "wavecraft-dev-server" "$DEV_SERVER_VERSION"
          fi

          # Wait for engine crates if they were published in this workflow
          ENGINE_VERSION="${{ needs.publish-engine.outputs.version }}"
          if [ -n "$ENGINE_VERSION" ]; then
            bash scripts/ci/wait-for-crate.sh "wavecraft-core" "$ENGINE_VERSION"
            bash scripts/ci/wait-for-crate.sh "wavecraft-protocol" "$ENGINE_VERSION"
            bash scripts/ci/wait-for-crate.sh "wavecraft-bridge" "$ENGINE_VERSION"
            bash scripts/ci/wait-for-crate.sh "wavecraft-metering" "$ENGINE_VERSION"
            bash scripts/ci/wait-for-crate.sh "wavecraft-dsp" "$ENGINE_VERSION"
            bash scripts/ci/wait-for-crate.sh "wavecraft-macros" "$ENGINE_VERSION"
          fi

          # Force Cargo to refresh its index cache
          echo "Refreshing Cargo index cache..."
          cargo search wavecraft --limit 1 > /dev/null 2>&1 || true
          echo "✅ Index propagation complete"

      - name: Sync dependencies with published versions
        run: |
          ENGINE_VERSION="${{ needs.publish-engine.outputs.version }}"
          DEV_SERVER_VERSION="${{ needs.publish-dev-server.outputs.version }}"

          if [ -n "$ENGINE_VERSION" ]; then
            echo "Syncing CLI engine deps to $ENGINE_VERSION"

            # Update CLI dependency version specifiers
            sed -i 's/\(wavecraft-protocol = { .*version = \)"[^"]*"/\1"'"$ENGINE_VERSION"'"/' cli/Cargo.toml
            sed -i 's/\(wavecraft-bridge = { .*version = \)"[^"]*"/\1"'"$ENGINE_VERSION"'"/' cli/Cargo.toml

            # Replay engine workspace version bump locally (needed for path dep resolution)
            sed -i '/^\[workspace\.package\]/,/^\[/{s/^version = ".*"/version = "'"$ENGINE_VERSION"'"/}' engine/Cargo.toml
            sed -i 's/\(wavecraft-[a-z_]* = { .*version = \)"[^"]*"/\1"'"$ENGINE_VERSION"'"/' engine/Cargo.toml
            for crate_dir in engine/crates/wavecraft-*/; do
              if [ -f "$crate_dir/Cargo.toml" ]; then
                sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$ENGINE_VERSION"'"/}' "$crate_dir/Cargo.toml"
              fi
            done
          fi

          if [ -n "$DEV_SERVER_VERSION" ]; then
            echo "Syncing CLI dev-server dep to $DEV_SERVER_VERSION"

            # Update CLI dependency version specifier for dev-server
            sed -i 's/\(wavecraft-dev-server = { .*version = \)"[^"]*"/\1"'"$DEV_SERVER_VERSION"'"/' cli/Cargo.toml

            # Replay dev-server version bump locally (needed for path dep resolution)
            sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$DEV_SERVER_VERSION"'"/}' dev-server/Cargo.toml

            # Also sync dev-server's engine dep versions if engine was published
            if [ -n "$ENGINE_VERSION" ]; then
              sed -i 's/\(wavecraft-bridge = { .*version = \)"[^"]*"/\1"'"$ENGINE_VERSION"'"/' dev-server/Cargo.toml
              sed -i 's/\(wavecraft-protocol = { .*version = \)"[^"]*"/\1"'"$ENGINE_VERSION"'"/' dev-server/Cargo.toml
            fi
          fi

          # Verify
          echo "=== cli/Cargo.toml wavecraft deps ==="
          grep -E 'wavecraft-' cli/Cargo.toml || true
          echo "=== dev-server version ==="
          grep -m1 'version = "' dev-server/Cargo.toml || true
          echo "=== engine workspace version ==="
          sed -n '/\[workspace\.package\]/,/^\[/{/version/p}' engine/Cargo.toml || true

      - name: Validate CLI dependencies
        working-directory: engine
        run: cargo xtask validate-cli-deps --check-registry

      - name: Query registry version
        id: registry
        run: |
          # Query crates.io API with explicit HTTP status check
          HTTP_CODE=$(curl -s -o /tmp/crate-info.json -w "%{http_code}" \
            -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
            "https://crates.io/api/v1/crates/wavecraft")

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "⚠️  crates.io API returned HTTP $HTTP_CODE"
            echo "registry_available=false" >> $GITHUB_OUTPUT
            echo "published=unknown" >> $GITHUB_OUTPUT
          else
            PUBLISHED=$(jq -r '.crate.max_version // empty' /tmp/crate-info.json 2>/dev/null)
            if [ -z "$PUBLISHED" ] || [ "$PUBLISHED" = "null" ]; then
              echo "⚠️  Failed to parse version from crates.io API"
              echo "registry_available=false" >> $GITHUB_OUTPUT
              echo "published=unknown" >> $GITHUB_OUTPUT
            else
              echo "✅ Latest on crates.io: $PUBLISHED"
              echo "registry_available=true" >> $GITHUB_OUTPUT
              echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Determine publish version
        id: version
        env:
          IS_FORCE_PUBLISH: ${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-cli }}
        run: |
          CURRENT=$(cargo metadata --manifest-path cli/Cargo.toml --no-deps --format-version 1 | jq -r '.packages[0].version')
          PUBLISHED="${{ steps.registry.outputs.published }}"
          REGISTRY_OK="${{ steps.registry.outputs.registry_available }}"

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Local version:     $CURRENT"
          echo "Published version: $PUBLISHED"
          echo "Registry OK:       $REGISTRY_OK"
          echo "Force publish:     $IS_FORCE_PUBLISH"

          # Decision logic
          if [ "$REGISTRY_OK" != "true" ]; then
            # Registry unavailable — cannot determine if bump needed
            if [ "$IS_FORCE_PUBLISH" = "true" ]; then
              echo "❌ Cannot force-publish: registry query failed (cannot determine safe bump target)"
              exit 1
            else
              echo "⚠️  Registry unavailable, but this is not a force-publish. Skipping."
              echo "action=skip" >> $GITHUB_OUTPUT
            fi
          elif [ "$IS_FORCE_PUBLISH" = "true" ]; then
            # Force-publish: if local is already ahead, publish as-is; otherwise bump
            if [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
              echo "action=publish" >> $GITHUB_OUTPUT
              echo "version=$CURRENT" >> $GITHUB_OUTPUT
              echo "Force-publish requested — local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
            else
              echo "action=bump" >> $GITHUB_OUTPUT
              echo "Force-publish requested — will auto-bump from $PUBLISHED"
            fi
          elif [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
            # Local version is ahead of published — publish as-is
            echo "action=publish" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
          elif [ "$CURRENT" = "$PUBLISHED" ]; then
            # Same version as published — auto-bump
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT equals published — will auto-bump"
          else
            # Local is behind published — auto-bump from published version
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "⚠️  Local version $CURRENT is BEHIND published $PUBLISHED — will auto-bump from published"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.action == 'bump'
        run: |
          PUBLISHED=${{ steps.registry.outputs.published }}
          NEW=$(npx --yes semver "$PUBLISHED" -i patch)
          sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$NEW"'"/}' cli/Cargo.toml
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped CLI to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cli/Cargo.toml
          git commit -m "chore: bump wavecraft CLI to ${{ steps.bump.outputs.version }} [auto-bump]"
          # NOTE: No push to main — branch protection prevents direct pushes.
          # The version bump exists locally for cargo publish and tagging only.

      - name: Set final version
        id: final
        if: steps.version.outputs.action != 'skip'
        run: |
          if [ "${{ steps.version.outputs.action }}" = "bump" ]; then
            VERSION="${{ steps.bump.outputs.version }}"
          else
            VERSION="${{ steps.version.outputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify version not already published
        if: steps.version.outputs.action != 'skip'
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Check if this exact version exists on crates.io
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
            "https://crates.io/api/v1/crates/wavecraft/$VERSION")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "❌ Version $VERSION already exists on crates.io!"
            echo "This means the auto-bump logic failed to produce a new version."
            exit 1
          elif [ "$HTTP_CODE" != "404" ]; then
            echo "❌ Could not verify published version state (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "✅ Version $VERSION is not yet on crates.io — safe to publish"

      - name: Stage SDK template for CLI packaging
        if: steps.version.outputs.action != 'skip'
        run: |
          rm -rf cli/sdk-template
          mkdir -p cli/sdk-template

          rsync -a --delete \
            --exclude target \
            --exclude node_modules \
            --exclude dist \
            --exclude Cargo.toml \
            --exclude engine/Cargo.toml \
            --exclude engine/xtask/Cargo.toml \
            sdk-template/ cli/sdk-template/

          # Ensure cargo package picks up the staged files from git metadata mode.
          git add -A -f cli/sdk-template

      - name: Create temporary packaging commit
        if: steps.version.outputs.action != 'skip'
        id: package_commit
        run: |
          if git diff --cached --quiet -- cli/sdk-template; then
            echo "created=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: stage sdk-template for CLI packaging [ci-temp]"
          echo "created=true" >> $GITHUB_OUTPUT

      - name: Verify publishability (dry-run)
        if: steps.version.outputs.action != 'skip'
        working-directory: cli
        run: cargo publish --dry-run

      - name: Authenticate with crates.io (OIDC)
        if: steps.version.outputs.action != 'skip'
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        if: steps.version.outputs.action != 'skip'
        working-directory: cli
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: cargo publish

      - name: Create and push git tag
        if: steps.version.outputs.action != 'skip'
        run: |
          git tag "wavecraft-cli-v${{ steps.final.outputs.version }}"
          git push origin "wavecraft-cli-v${{ steps.final.outputs.version }}"

  # ============================================================================
  # Job 3: Publish engine crates to crates.io
  # ============================================================================
  publish-engine:
    needs: detect-changes
    if: needs.detect-changes.outputs.engine == 'true' || needs.detect-changes.outputs.cli == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for crates.io trusted publishing (OIDC)
      contents: write # For version bump commits and git tags
    outputs:
      version: ${{ steps.verified.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for cargo-workspaces version detection

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libglib2.0-dev \
            libgtk-3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libwebkit2gtk-4.1-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: engine

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Query registry version
        id: registry
        run: |
          REQUIRED_CRATES=(
            wavecraft-core
            wavecraft-protocol
            wavecraft-bridge
            wavecraft-metering
            wavecraft-dsp
            wavecraft-macros
          )

          PUBLISHED_VERSIONS=()
          REGISTRY_OK=true

          for crate in "${REQUIRED_CRATES[@]}"; do
            HTTP_CODE=$(curl -s -o /tmp/crate-info.json -w "%{http_code}" \
              -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
              "https://crates.io/api/v1/crates/$crate")

            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "⚠️  crates.io API returned HTTP $HTTP_CODE for $crate"
              REGISTRY_OK=false
              break
            fi

            VERSION=$(jq -r '.crate.max_version // empty' /tmp/crate-info.json 2>/dev/null)
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "⚠️  Failed to parse max_version from crates.io API for $crate"
              REGISTRY_OK=false
              break
            fi

            PUBLISHED_VERSIONS+=("$VERSION")
            echo "- $crate latest: $VERSION"
          done

          if [ "$REGISTRY_OK" != "true" ]; then
            echo "registry_available=false" >> $GITHUB_OUTPUT
            echo "published=unknown" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Use highest published version across required engine crates as safe baseline
          PUBLISHED=$(printf '%s\n' "${PUBLISHED_VERSIONS[@]}" | sort -V | tail -1)
          UNIQUE_COUNT=$(printf '%s\n' "${PUBLISHED_VERSIONS[@]}" | sort -u | wc -l | tr -d ' ')

          if [ "$UNIQUE_COUNT" -gt 1 ]; then
            echo "⚠️  Engine registry drift detected across crates (versions are not aligned)."
            echo "⚠️  Using highest published version as bump baseline: $PUBLISHED"
          else
            echo "✅ Required engine crates aligned on crates.io at version: $PUBLISHED"
          fi

          echo "registry_available=true" >> $GITHUB_OUTPUT
          echo "published=$PUBLISHED" >> $GITHUB_OUTPUT

      - name: Determine publish version
        id: version
        env:
          IS_FORCE_PUBLISH: ${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-engine }}
        run: |
          CURRENT=$(grep -m1 'version = "' engine/Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          PUBLISHED="${{ steps.registry.outputs.published }}"
          REGISTRY_OK="${{ steps.registry.outputs.registry_available }}"

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Local version:     $CURRENT"
          echo "Published version: $PUBLISHED"
          echo "Registry OK:       $REGISTRY_OK"
          echo "Force publish:     $IS_FORCE_PUBLISH"

          # Decision logic
          if [ "$REGISTRY_OK" != "true" ]; then
            # Registry unavailable — cannot determine if bump needed
            if [ "$IS_FORCE_PUBLISH" = "true" ]; then
              echo "❌ Cannot force-publish: registry query failed (cannot determine safe bump target)"
              exit 1
            else
              echo "⚠️  Registry unavailable, but this is not a force-publish. Skipping."
              echo "action=skip" >> $GITHUB_OUTPUT
            fi
          elif [ "$IS_FORCE_PUBLISH" = "true" ]; then
            # Force-publish: if local is already ahead, publish as-is; otherwise bump
            if [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
              echo "action=publish" >> $GITHUB_OUTPUT
              echo "version=$CURRENT" >> $GITHUB_OUTPUT
              echo "Force-publish requested — local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
            else
              echo "action=bump" >> $GITHUB_OUTPUT
              echo "Force-publish requested — will auto-bump from $PUBLISHED"
            fi
          elif [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
            # Local version is ahead of published — publish as-is
            echo "action=publish" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
          elif [ "$CURRENT" = "$PUBLISHED" ]; then
            # Same version as published — auto-bump
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT equals published — will auto-bump"
          else
            # Local is behind published — auto-bump from published version
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "⚠️  Local version $CURRENT is BEHIND published $PUBLISHED — will auto-bump from published"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.action == 'bump'
        working-directory: engine
        run: |
          PUBLISHED="${{ steps.registry.outputs.published }}"
          NEW=$(npx --yes semver "$PUBLISHED" -i patch)
          echo "Bumping engine workspace from ${{ steps.version.outputs.current }} to $NEW"

          # Always force all publishable workspace crates to the same engine version.
          # This keeps engine crate versions aligned and avoids partial-version publishes
          # that break downstream verification/dependency syncing.
          cargo ws version custom "$NEW" --yes --no-git-commit --all --force "*"

          # Verify the bump actually changed files
          if git diff --quiet; then
            echo "❌ cargo ws version custom did not modify any files"
            exit 1
          fi

          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "✅ Auto-bumped engine crates to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.version != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add engine/
          git commit -m "chore: bump engine crates to ${{ steps.bump.outputs.version }} [auto-bump]"
          echo "✅ Committed version bump"

      - name: Set final version
        id: final
        if: steps.version.outputs.action != 'skip'
        run: |
          if [ "${{ steps.version.outputs.action }}" = "bump" ]; then
            VERSION="${{ steps.bump.outputs.version }}"
          else
            VERSION="${{ steps.version.outputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify engine workspace version alignment
        if: steps.version.outputs.action != 'skip'
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          WORKSPACE_VERSION=$(awk '
            /^\[workspace\.package\]/ { in_section=1; next }
            /^\[/ { in_section=0 }
            in_section && /^version = "/ {
              n = split($0, parts, "\"")
              if (n >= 2) {
                print parts[2]
              }
              exit
            }
          ' engine/Cargo.toml)

          if [ -z "$WORKSPACE_VERSION" ]; then
            echo "❌ Could not determine workspace version from engine/Cargo.toml"
            exit 1
          fi

          REQUIRED_CRATES=(
            wavecraft-core
            wavecraft-protocol
            wavecraft-bridge
            wavecraft-metering
            wavecraft-dsp
            wavecraft-macros
          )

          echo "Verifying engine crate versions are aligned to $VERSION..."
          for crate in "${REQUIRED_CRATES[@]}"; do
            MANIFEST="engine/crates/$crate/Cargo.toml"
            if [ ! -f "$MANIFEST" ]; then
              echo "❌ Missing manifest: $MANIFEST"
              exit 1
            fi

            if grep -q '^version\.workspace = true' "$MANIFEST"; then
              CRATE_VERSION="$WORKSPACE_VERSION"
            else
              CRATE_VERSION=$(grep -m1 '^version = "' "$MANIFEST" | sed 's/.*"\(.*\)".*/\1/')
            fi

            if [ -z "$CRATE_VERSION" ]; then
              echo "❌ Could not determine crate version for $crate from $MANIFEST"
              exit 1
            fi

            if [ "$CRATE_VERSION" != "$VERSION" ]; then
              echo "❌ Version mismatch: $crate has $CRATE_VERSION, expected $VERSION"
              exit 1
            fi
          done

          echo "✅ All required engine crates aligned to $VERSION"

      - name: Verify version not already published
        if: steps.version.outputs.action != 'skip'
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Check if this exact version exists on crates.io
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
            "https://crates.io/api/v1/crates/wavecraft-core/$VERSION")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "❌ Version $VERSION already exists on crates.io!"
            echo "This means the auto-bump logic failed to produce a new version."
            exit 1
          elif [ "$HTTP_CODE" != "404" ]; then
            echo "❌ Could not verify published version state (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "✅ Version $VERSION is not yet on crates.io — safe to publish"

      - name: Verify publishability (dry-run)
        if: steps.version.outputs.action != 'skip'
        working-directory: engine
        run: |
          cargo ws publish \
            --yes \
            --no-git-push \
            --allow-branch main \
            --from-git \
            --dry-run

      - name: Authenticate with crates.io (OIDC)
        if: steps.version.outputs.action != 'skip'
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        if: steps.version.outputs.action != 'skip'
        working-directory: engine
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: |
          cargo ws publish \
            --yes \
            --no-git-push \
            --allow-branch main \
            --from-git

      - name: Verify publish results (post-publish audit)
        if: steps.version.outputs.action != 'skip'
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          REQUIRED_CRATES=(
            wavecraft-core
            wavecraft-protocol
            wavecraft-bridge
            wavecraft-metering
            wavecraft-dsp
            wavecraft-macros
          )

          echo "╔══════════════════════════════════════════════════════════╗"
          echo "║  Post-Publish Audit — expected version: $VERSION       ║"
          echo "╚══════════════════════════════════════════════════════════╝"

          PUBLISHED_COUNT=0
          SKIPPED_COUNT=0
          MISSING=()

          for crate in "${REQUIRED_CRATES[@]}"; do
            HTTP_CODE=$(curl -s -o /tmp/crate-ver.json -w "%{http_code}" \
              -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
              "https://crates.io/api/v1/crates/$crate/$VERSION")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "  ✅ $crate@$VERSION — published"
              PUBLISHED_COUNT=$((PUBLISHED_COUNT + 1))
            elif [ "$HTTP_CODE" = "404" ]; then
              # Check what version IS actually latest
              LATEST=$(curl -s \
                -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
                "https://crates.io/api/v1/crates/$crate" \
                | jq -r '.crate.max_version // "unknown"' 2>/dev/null)
              echo "  ❌ $crate@$VERSION — NOT FOUND (latest: $LATEST)"
              MISSING+=("$crate (latest: $LATEST)")
            else
              echo "  ⚠️  $crate — HTTP $HTTP_CODE (registry issue)"
              SKIPPED_COUNT=$((SKIPPED_COUNT + 1))
            fi
          done

          echo ""
          echo "Published: $PUBLISHED_COUNT / ${#REQUIRED_CRATES[@]}"

          if [ ${#MISSING[@]} -gt 0 ]; then
            echo ""
            echo "❌ The following required crates were NOT published at $VERSION:"
            for m in "${MISSING[@]}"; do
              echo "   - $m"
            done
            echo ""
            echo "This means cargo ws publish only published a subset of engine crates."
            echo "Root cause: version bump did not apply to all required crates."
            exit 1
          fi

          echo "✅ Post-publish audit passed"

      - name: Verify all required engine crates are available on crates.io
        if: steps.version.outputs.action != 'skip'
        id: verified
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          REQUIRED_CRATES=(
            wavecraft-core
            wavecraft-protocol
            wavecraft-bridge
            wavecraft-metering
            wavecraft-dsp
            wavecraft-macros
          )

          echo "Verifying required engine crates are available at version $VERSION..."
          for crate in "${REQUIRED_CRATES[@]}"; do
            bash scripts/ci/wait-for-crate.sh "$crate" "$VERSION"
          done

          echo "✅ All required engine crates are available at $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Push tags only
        if: steps.version.outputs.action != 'skip'
        run: git push origin --tags

  # ============================================================================
  # Job 3b: Publish dev-server crate to crates.io
  # ============================================================================
  publish-dev-server:
    needs: [detect-changes, publish-engine]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.dev-server == 'true' &&
      (
        (needs.detect-changes.outputs.engine != 'true' && needs.detect-changes.outputs.cli != 'true') ||
        needs.publish-engine.outputs.version != ''
      ) &&
      (needs.publish-engine.result == 'success' || needs.publish-engine.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    outputs:
      version: ${{ steps.final.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Linux system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libasound2-dev

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: dev-server

      - name: Sync version with engine (if engine published)
        if: needs.publish-engine.outputs.version != ''
        run: |
          TARGET="${{ needs.publish-engine.outputs.version }}"
          echo "Syncing dev-server to engine version $TARGET"

          # ── 1. Update dev-server's own version and dependency versions ──
          sed -i 's/^version = ".*"/version = "'"$TARGET"'"/' dev-server/Cargo.toml
          sed -i 's/\(wavecraft-bridge = { .*version = \)"[^"]*"/\1"'"$TARGET"'"/' dev-server/Cargo.toml
          sed -i 's/\(wavecraft-protocol = { .*version = \)"[^"]*"/\1"'"$TARGET"'"/' dev-server/Cargo.toml

          # ── 2. Replay the engine version bump locally ──
          # publish-engine bumped these in its (now-gone) workspace.
          # We must match them so path dep resolution succeeds.

          # 2a. Engine workspace package version
          sed -i '/^\[workspace\.package\]/,/^\[/{s/^version = ".*"/version = "'"$TARGET"'"/}' engine/Cargo.toml

          # 2b. Engine workspace dependency version specifiers
          sed -i 's/\(wavecraft-[a-z_]* = { .*version = \)"[^"]*"/\1"'"$TARGET"'"/' engine/Cargo.toml

          # 2c. Individual crate package versions
          for crate_dir in engine/crates/wavecraft-*/; do
            if [ -f "$crate_dir/Cargo.toml" ]; then
              sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$TARGET"'"/}' "$crate_dir/Cargo.toml"
            fi
          done

          # ── 3. Verify ──
          echo "=== dev-server/Cargo.toml ==="
          head -3 dev-server/Cargo.toml
          grep -E 'wavecraft-(bridge|protocol)' dev-server/Cargo.toml
          echo "=== engine workspace version ==="
          sed -n '/\[workspace\.package\]/,/^\[/{/version/p}' engine/Cargo.toml
          echo "=== engine crate versions ==="
          for f in engine/crates/wavecraft-*/Cargo.toml; do
            echo "  $(dirname $f | xargs basename): $(grep -m1 'version = "' $f)"
          done

      - name: Wait for engine crates on crates.io
        if: needs.publish-engine.outputs.version != ''
        run: |
          TARGET="${{ needs.publish-engine.outputs.version }}"
          echo "Waiting for wavecraft-bridge $TARGET and wavecraft-protocol $TARGET on crates.io..."

          bash scripts/ci/wait-for-crate.sh "wavecraft-protocol" "$TARGET"
          bash scripts/ci/wait-for-crate.sh "wavecraft-bridge" "$TARGET"

          # Force Cargo to refresh its index cache
          cargo search wavecraft-bridge --limit 1 > /dev/null 2>&1 || true

      - name: Query registry version
        id: registry
        run: |
          # Query crates.io API with explicit HTTP status check
          HTTP_CODE=$(curl -s -o /tmp/crate-info.json -w "%{http_code}" \
            -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
            "https://crates.io/api/v1/crates/wavecraft-dev-server")

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "⚠️  crates.io API returned HTTP $HTTP_CODE"
            echo "registry_available=false" >> $GITHUB_OUTPUT
            echo "published=unknown" >> $GITHUB_OUTPUT
          else
            PUBLISHED=$(jq -r '.crate.max_version // empty' /tmp/crate-info.json 2>/dev/null)
            if [ -z "$PUBLISHED" ] || [ "$PUBLISHED" = "null" ]; then
              echo "⚠️  Failed to parse version from crates.io API"
              echo "registry_available=false" >> $GITHUB_OUTPUT
              echo "published=unknown" >> $GITHUB_OUTPUT
            else
              echo "✅ Latest on crates.io: $PUBLISHED"
              echo "registry_available=true" >> $GITHUB_OUTPUT
              echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Determine publish version
        id: version
        env:
          IS_FORCE_PUBLISH: ${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-dev-server }}
        run: |
          CURRENT=$(grep -m1 'version = "' dev-server/Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          PUBLISHED="${{ steps.registry.outputs.published }}"
          REGISTRY_OK="${{ steps.registry.outputs.registry_available }}"

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "Local version:     $CURRENT"
          echo "Published version: $PUBLISHED"
          echo "Registry OK:       $REGISTRY_OK"
          echo "Force publish:     $IS_FORCE_PUBLISH"

          # Decision logic
          if [ "$REGISTRY_OK" != "true" ]; then
            # Registry unavailable — cannot determine if bump needed
            if [ "$IS_FORCE_PUBLISH" = "true" ]; then
              echo "❌ Cannot force-publish: registry query failed (cannot determine safe bump target)"
              exit 1
            else
              echo "⚠️  Registry unavailable, but this is not a force-publish. Skipping."
              echo "action=skip" >> $GITHUB_OUTPUT
            fi
          elif [ "$IS_FORCE_PUBLISH" = "true" ]; then
            # Force-publish: if local is already ahead, publish as-is; otherwise bump
            if [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
              echo "action=publish" >> $GITHUB_OUTPUT
              echo "version=$CURRENT" >> $GITHUB_OUTPUT
              echo "Force-publish requested — local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
            else
              echo "action=bump" >> $GITHUB_OUTPUT
              echo "Force-publish requested — will auto-bump from $PUBLISHED"
            fi
          elif [ "$CURRENT" != "$PUBLISHED" ] && \
               [ "$(printf '%s\n' "$PUBLISHED" "$CURRENT" | sort -V | tail -1)" = "$CURRENT" ]; then
            # Local version is ahead of published — publish as-is
            echo "action=publish" >> $GITHUB_OUTPUT
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT is ahead of published $PUBLISHED — publishing as-is"
          elif [ "$CURRENT" = "$PUBLISHED" ]; then
            # Same version as published — auto-bump
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "Local version $CURRENT equals published — will auto-bump"
          else
            # Local is behind published — auto-bump from published version
            echo "action=bump" >> $GITHUB_OUTPUT
            echo "⚠️  Local version $CURRENT is BEHIND published $PUBLISHED — will auto-bump from published"
          fi

      - name: Auto-bump patch version (if needed)
        id: bump
        if: steps.version.outputs.action == 'bump'
        run: |
          PUBLISHED="${{ steps.registry.outputs.published }}"
          NEW=$(npx --yes semver "$PUBLISHED" -i patch)
          sed -i '/^\[package\]/,/^\[/{s/^version = ".*"/version = "'"$NEW"'"/}' dev-server/Cargo.toml
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "Auto-bumped dev-server to $NEW"

      - name: Commit auto-bump locally
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dev-server/Cargo.toml
          git commit -m "chore: bump wavecraft-dev-server to ${{ steps.bump.outputs.version }} [auto-bump]"

      - name: Set final version
        id: final
        if: steps.version.outputs.action != 'skip'
        run: |
          if [ "${{ steps.version.outputs.action }}" = "bump" ]; then
            VERSION="${{ steps.bump.outputs.version }}"
          else
            VERSION="${{ steps.version.outputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Verify version not already published
        if: steps.version.outputs.action != 'skip'
        run: |
          VERSION="${{ steps.final.outputs.version }}"
          # Check if this exact version exists on crates.io
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: wavecraft-ci (https://github.com/RonHouben/wavecraft)" \
            "https://crates.io/api/v1/crates/wavecraft-dev-server/$VERSION")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "❌ Version $VERSION already exists on crates.io!"
            echo "This means the auto-bump logic failed to produce a new version."
            exit 1
          elif [ "$HTTP_CODE" != "404" ]; then
            echo "❌ Could not verify published version state (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "✅ Version $VERSION is not yet on crates.io — safe to publish"

      - name: Verify publishability (dry-run)
        if: steps.version.outputs.action != 'skip'
        working-directory: dev-server
        run: cargo publish --dry-run

      - name: Authenticate with crates.io (OIDC)
        if: steps.version.outputs.action != 'skip'
        id: crates-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        if: steps.version.outputs.action != 'skip'
        working-directory: dev-server
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-auth.outputs.token }}
        run: |
          MAX_ATTEMPTS=3
          DELAY=30

          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "Publish attempt $i/$MAX_ATTEMPTS..."
            if cargo publish; then
              echo "✅ Published successfully"
              exit 0
            fi
            
            if [ "$i" -lt "$MAX_ATTEMPTS" ]; then
              echo "⏳ Publish failed, retrying in ${DELAY}s..."
              sleep $DELAY
              DELAY=$((DELAY * 2))
            fi
          done

          echo "❌ All publish attempts failed"
          exit 1

      - name: Create and push git tag
        if: steps.version.outputs.action != 'skip'
        run: |
          git tag "wavecraft-dev-server-v${{ steps.final.outputs.version }}"
          git push origin "wavecraft-dev-server-v${{ steps.final.outputs.version }}"

  # ============================================================================
  # Job 4: Prepare npm cohort lockstep target version
  # ============================================================================
  publish-npm-cohort-prepare:
    needs: detect-changes
    if: needs.detect-changes.outputs.npm-cohort == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.target.outputs.version }}
      core-already-published: ${{ steps.target.outputs.core_already_published }}
      components-already-published: ${{ steps.target.outputs.components_already_published }}
      registry-available: ${{ steps.target.outputs.registry_available }}
      registry-state: ${{ steps.target.outputs.registry_state }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Compute cohort target version
        id: target
        working-directory: ui
        env:
          FORCE_COHORT: ${{ github.event_name == 'workflow_dispatch' && inputs.force-publish-npm-cohort }}
        run: |
          npm_fetch_version() {
            local package="$1"
            local max_attempts=3
            local delay=2
            local attempt output parsed

            for attempt in $(seq 1 "$max_attempts"); do
              if output=$(npm view "$package" version --json 2>&1); then
                parsed=$(node -e "const raw = process.argv[1]; let value = JSON.parse(raw); if (Array.isArray(value)) value = value[value.length - 1]; if (!value) process.exit(1); process.stdout.write(String(value));" "$output" 2>/dev/null) || {
                  echo "::error::Failed to parse npm version JSON for $package: $output" >&2
                  return 1
                }
                echo "$parsed"
                return 0
              fi

              if echo "$output" | grep -qiE 'E404|404 Not Found|is not in this registry'; then
                echo "0.0.0"
                return 0
              fi

              if [ "$attempt" -lt "$max_attempts" ]; then
                echo "::warning::npm registry lookup failed for $package (attempt $attempt/$max_attempts). Retrying in ${delay}s..."
                sleep "$delay"
                delay=$((delay * 2))
              else
                echo "::error::npm registry lookup failed for $package after $max_attempts attempts: $output" >&2
                return 1
              fi
            done
          }

          npm_version_exists() {
            local package="$1"
            local version="$2"
            local max_attempts=3
            local delay=2
            local attempt output

            for attempt in $(seq 1 "$max_attempts"); do
              if output=$(npm view "$package@$version" version 2>&1); then
                echo "true"
                return 0
              fi

              if echo "$output" | grep -qiE 'E404|404 Not Found|is not in this registry'; then
                echo "false"
                return 0
              fi

              if [ "$attempt" -lt "$max_attempts" ]; then
                echo "::warning::npm published-version check failed for $package@$version (attempt $attempt/$max_attempts). Retrying in ${delay}s..."
                sleep "$delay"
                delay=$((delay * 2))
              else
                echo "::error::npm published-version check failed for $package@$version after $max_attempts attempts: $output" >&2
                return 1
              fi
            done
          }

          CORE_LOCAL=$(node -p "require('./packages/core/package.json').version")
          COMPONENTS_LOCAL=$(node -p "require('./packages/components/package.json').version")

          if ! CORE_PUBLISHED=$(npm_fetch_version "@wavecraft/core"); then
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "core_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "components_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "registry_available=false" >> "$GITHUB_OUTPUT"
            echo "registry_state=unknown" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! COMPONENTS_PUBLISHED=$(npm_fetch_version "@wavecraft/components"); then
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "core_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "components_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "registry_available=false" >> "$GITHUB_OUTPUT"
            echo "registry_state=unknown" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TARGET=$(printf '%s\n' "$CORE_LOCAL" "$COMPONENTS_LOCAL" "$CORE_PUBLISHED" "$COMPONENTS_PUBLISHED" | sort -V | tail -1)

          echo "Core local:          $CORE_LOCAL"
          echo "Components local:    $COMPONENTS_LOCAL"
          echo "Core published:      $CORE_PUBLISHED"
          echo "Components published:$COMPONENTS_PUBLISHED"
          echo "Cohort target:       $TARGET"

          if [ "$FORCE_COHORT" = "true" ]; then
            echo "Cohort force-publish requested"
          fi

          if ! CORE_ALREADY=$(npm_version_exists "@wavecraft/core" "$TARGET"); then
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "core_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "components_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "registry_available=false" >> "$GITHUB_OUTPUT"
            echo "registry_state=unknown" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if ! COMPONENTS_ALREADY=$(npm_version_exists "@wavecraft/components" "$TARGET"); then
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "core_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "components_already_published=unknown" >> "$GITHUB_OUTPUT"
            echo "registry_available=false" >> "$GITHUB_OUTPUT"
            echo "registry_state=unknown" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "version=$TARGET" >> "$GITHUB_OUTPUT"
          echo "core_already_published=$CORE_ALREADY" >> "$GITHUB_OUTPUT"
          echo "components_already_published=$COMPONENTS_ALREADY" >> "$GITHUB_OUTPUT"
          echo "registry_available=true" >> "$GITHUB_OUTPUT"
          echo "registry_state=available" >> "$GITHUB_OUTPUT"

  # ============================================================================
  # Job 5: Publish @wavecraft/core to npm (cohort lockstep)
  # ============================================================================
  publish-npm-core:
    needs: [detect-changes, publish-npm-cohort-prepare]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.npm-cohort == 'true' &&
      needs.publish-npm-cohort-prepare.outputs.registry-available == 'true' &&
      needs.publish-npm-cohort-prepare.result == 'success'
    outputs:
      version: ${{ needs.publish-npm-cohort-prepare.outputs.version }}
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
    permissions:
      id-token: write # Required for npm OIDC trusted publishing + provenance
      contents: write # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: "@wavecraft"
          always-auth: false

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Clear npm auth token
        run: |
          npm config delete //registry.npmjs.org/:_authToken || true
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Align core package version to cohort target
        run: |
          TARGET="${{ needs.publish-npm-cohort-prepare.outputs.version }}"
          CURRENT=$(node -p "require('./ui/packages/core/package.json').version")
          echo "Core current: $CURRENT"
          echo "Cohort target: $TARGET"
          if [ "$CURRENT" != "$TARGET" ]; then
            npm --prefix ui/packages/core version "$TARGET" --no-git-tag-version
          fi

      - name: Commit local lockstep alignment
        run: |
          if git diff --quiet -- ui/packages/core/package.json; then
            echo "No lockstep alignment changes for core"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ui/packages/core/package.json
          git commit -m "chore: align @wavecraft/core to npm cohort lockstep ${{ needs.publish-npm-cohort-prepare.outputs.version }} [auto-bump]"

      - name: Build package
        working-directory: ui/packages/core
        run: npm run build:lib

      - name: Verify publishability (dry-run)
        working-directory: ui/packages/core
        run: npm publish --access public --dry-run

      - name: Publish to npm (idempotent)
        working-directory: ui/packages/core
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          TARGET="${{ needs.publish-npm-cohort-prepare.outputs.version }}"
          PACKAGE="@wavecraft/core"

          if [ "${{ needs.publish-npm-cohort-prepare.outputs.core-already-published }}" = "true" ]; then
            echo "✅ $PACKAGE@$TARGET already published (preflight) — skipping"
            exit 0
          fi

          # TOCTOU guard: recheck immediately before publish attempt.
          if npm view "$PACKAGE@$TARGET" version >/dev/null 2>&1; then
            echo "✅ $PACKAGE@$TARGET already published (just-before-publish recheck) — skipping"
            exit 0
          fi

          PUBLISH_LOG=$(mktemp)
          if npm publish --access public --provenance >"$PUBLISH_LOG" 2>&1; then
            cat "$PUBLISH_LOG"
            echo "✅ Published $PACKAGE@$TARGET"
            exit 0
          fi

          cat "$PUBLISH_LOG"

          # If publish lost a race on duplicate-version, confirm registry state and treat as success.
          if grep -qiE 'EPUBLISHCONFLICT|cannot publish over the previously published versions|cannot publish over existing version|You cannot publish over previously published version' "$PUBLISH_LOG"; then
            echo "⚠️ Duplicate-version publish error detected for $PACKAGE@$TARGET. Confirming npm registry state..."
            CONFIRM_DELAYS=(2 4 8)
            for i in "${!CONFIRM_DELAYS[@]}"; do
              ATTEMPT=$((i + 1))
              DELAY="${CONFIRM_DELAYS[$i]}"
              echo "⏳ Confirm attempt $ATTEMPT/${#CONFIRM_DELAYS[@]} for $PACKAGE@$TARGET after ${DELAY}s backoff..."
              sleep "$DELAY"
              if npm view "$PACKAGE@$TARGET" version >/dev/null 2>&1; then
                echo "✅ $PACKAGE@$TARGET is now present on npm (confirm attempt $ATTEMPT) — treating duplicate publish race as success"
                exit 0
              fi
            done
            echo "❌ Duplicate-version signature detected, but $PACKAGE@$TARGET is still missing from npm after ${#CONFIRM_DELAYS[@]} confirmation attempts (2s/4s/8s backoff)"
            exit 1
          fi

          echo "❌ npm publish failed for $PACKAGE@$TARGET (non-duplicate error)"
          exit 1

      - name: Create and push git tag (if missing)
        run: |
          TARGET="${{ needs.publish-npm-cohort-prepare.outputs.version }}"
          TAG="@wavecraft/core-v$TARGET"
          if git ls-remote --tags origin "refs/tags/$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists — skipping"
            exit 0
          fi
          git tag "$TAG"
          git push origin "$TAG"

  # ============================================================================
  # Job 6: Publish @wavecraft/components to npm (cohort lockstep)
  # ============================================================================
  publish-npm-components:
    needs: [detect-changes, publish-npm-cohort-prepare, publish-npm-core]
    if: |
      !cancelled() &&
      needs.detect-changes.outputs.npm-cohort == 'true' &&
      needs.publish-npm-cohort-prepare.outputs.registry-available == 'true' &&
      needs.publish-npm-cohort-prepare.result == 'success' &&
      (needs.publish-npm-core.result == 'success' || needs.publish-npm-core.result == 'skipped')
    outputs:
      version: ${{ needs.publish-npm-cohort-prepare.outputs.version }}
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ""
      NPM_TOKEN: ""
    permissions:
      id-token: write # Required for npm OIDC trusted publishing + provenance
      contents: write # Required for version bump commits
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: "@wavecraft"
          always-auth: false

      - name: Update npm to latest
        run: npm install -g npm@latest

      - name: Clear npm auth token
        run: |
          npm config delete //registry.npmjs.org/:_authToken || true
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ]; then
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi

      - name: Install dependencies
        working-directory: ui
        run: npm ci

      - name: Align components version and @wavecraft/core dependency
        run: |
          TARGET="${{ needs.publish-npm-cohort-prepare.outputs.version }}"
          node -e "
            const fs = require('fs');
            const file = 'ui/packages/components/package.json';
            const pkg = JSON.parse(fs.readFileSync(file, 'utf8'));
            pkg.version = '$TARGET';
            if (pkg.dependencies && pkg.dependencies['@wavecraft/core']) {
              pkg.dependencies['@wavecraft/core'] = '^$TARGET';
            }
            if (pkg.peerDependencies && pkg.peerDependencies['@wavecraft/core']) {
              pkg.peerDependencies['@wavecraft/core'] = '^$TARGET';
            }
            fs.writeFileSync(file, JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Commit local lockstep alignment
        run: |
          if git diff --quiet -- ui/packages/components/package.json; then
            echo "No lockstep alignment changes for components"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ui/packages/components/package.json
          git commit -m "chore: align @wavecraft/components cohort lockstep ${{ needs.publish-npm-cohort-prepare.outputs.version }} [auto-bump]"

      - name: Build package
        working-directory: ui/packages/components
        run: npm run build:lib

      - name: Verify publishability (dry-run)
        working-directory: ui/packages/components
        run: npm publish --access public --dry-run

      - name: Publish to npm (idempotent)
        working-directory: ui/packages/components
        env:
          NPM_CONFIG_PROVENANCE: true
        run: |
          TARGET="${{ needs.publish-npm-cohort-prepare.outputs.version }}"
          PACKAGE="@wavecraft/components"

          if [ "${{ needs.publish-npm-cohort-prepare.outputs.components-already-published }}" = "true" ]; then
            echo "✅ $PACKAGE@$TARGET already published (preflight) — skipping"
            exit 0
          fi

          # TOCTOU guard: recheck immediately before publish attempt.
          if npm view "$PACKAGE@$TARGET" version >/dev/null 2>&1; then
            echo "✅ $PACKAGE@$TARGET already published (just-before-publish recheck) — skipping"
            exit 0
          fi

          PUBLISH_LOG=$(mktemp)
          if npm publish --access public --provenance >"$PUBLISH_LOG" 2>&1; then
            cat "$PUBLISH_LOG"
            echo "✅ Published $PACKAGE@$TARGET"
            exit 0
          fi

          cat "$PUBLISH_LOG"

          # If publish lost a race on duplicate-version, confirm registry state and treat as success.
          if grep -qiE 'EPUBLISHCONFLICT|cannot publish over the previously published versions|cannot publish over existing version|You cannot publish over previously published version' "$PUBLISH_LOG"; then
            echo "⚠️ Duplicate-version publish error detected for $PACKAGE@$TARGET. Confirming npm registry state..."
            CONFIRM_DELAYS=(2 4 8)
            for i in "${!CONFIRM_DELAYS[@]}"; do
              ATTEMPT=$((i + 1))
              DELAY="${CONFIRM_DELAYS[$i]}"
              echo "⏳ Confirm attempt $ATTEMPT/${#CONFIRM_DELAYS[@]} for $PACKAGE@$TARGET after ${DELAY}s backoff..."
              sleep "$DELAY"
              if npm view "$PACKAGE@$TARGET" version >/dev/null 2>&1; then
                echo "✅ $PACKAGE@$TARGET is now present on npm (confirm attempt $ATTEMPT) — treating duplicate publish race as success"
                exit 0
              fi
            done
            echo "❌ Duplicate-version signature detected, but $PACKAGE@$TARGET is still missing from npm after ${#CONFIRM_DELAYS[@]} confirmation attempts (2s/4s/8s backoff)"
            exit 1
          fi

          echo "❌ npm publish failed for $PACKAGE@$TARGET (non-duplicate error)"
          exit 1

      - name: Post-publish verify cohort alignment
        run: |
          TARGET="${{ needs.publish-npm-cohort-prepare.outputs.version }}"

          if ! npm view "@wavecraft/core@$TARGET" version >/dev/null 2>&1; then
            echo "❌ @wavecraft/core@$TARGET not found on npm"
            exit 1
          fi
          if ! npm view "@wavecraft/components@$TARGET" version >/dev/null 2>&1; then
            echo "❌ @wavecraft/components@$TARGET not found on npm"
            exit 1
          fi

          CORE_PEER=$(npm view "@wavecraft/components@$TARGET" peerDependencies."@wavecraft/core" 2>/dev/null || true)
          if [ "$CORE_PEER" != "^$TARGET" ]; then
            echo "❌ @wavecraft/components@$TARGET peer dependency mismatch: expected ^$TARGET, got '$CORE_PEER'"
            exit 1
          fi

          echo "✅ Cohort verification passed for version $TARGET"

      - name: Create and push git tag (if missing)
        run: |
          TARGET="${{ needs.publish-npm-cohort-prepare.outputs.version }}"
          TAG="@wavecraft/components-v$TARGET"
          if git ls-remote --tags origin "refs/tags/$TAG" | grep -q "$TAG"; then
            echo "Tag $TAG already exists — skipping"
            exit 0
          fi
          git tag "$TAG"
          git push origin "$TAG"
