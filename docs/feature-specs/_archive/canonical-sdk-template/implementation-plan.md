# Implementation Plan: Canonical SDK Template

## Overview

Consolidate three overlapping plugin scaffold sources (`cli/sdk-templates/new-project/react/`, `engine/crates/wavecraft-example/`, `ui/src/`) into a single canonical `sdk-template/` directory at the repo root. This directory becomes both the CLI template source and the dev target for `cargo xtask dev`.

**Based on:** [Low-Level Design](./low-level-design-canonical-sdk-template.md)

**Strategy:** Single atomic PR — all changes ship together.

---

## Requirements

- Single source of truth for plugin scaffold at `sdk-template/`
- `wavecraft create` embeds from `sdk-template/` instead of `cli/sdk-templates/new-project/react/`
- `cargo xtask dev` runs against `sdk-template/engine` + `sdk-template/ui` instead of `wavecraft-example` + `ui/`
- Legacy paths (`cli/sdk-templates/`, `wavecraft-example/`, `ui/src/`) removed
- CI/docs updated to reflect new structure
- Package development ergonomics (`ui/packages/*`) preserved via Vite aliases

---

## Architecture Changes

- `sdk-template/` — NEW directory at repo root (canonical plugin scaffold)
- `cli/src/template/mod.rs` L13 — `include_dir!` path changes from `sdk-templates/new-project/react` → `../sdk-template`
- `cli/src/project/detection.rs` L64–94 — SDK-mode branch redirects to `sdk-template/engine` + `sdk-template/ui` instead of `wavecraft-example` + `ui/`
- `engine/Cargo.toml` L2 — wavecraft-example removed (glob `crates/*` auto-excludes deleted crate)
- `.github/workflows/continuous-deploy.yml` L59 — path filter `cli/sdk-templates/**` → `sdk-template/**`
- `ui/src/` — removed; `ui/` becomes pure npm package workspace

---

## Single PR Strategy

> **PR title:** `refactor: canonical sdk-template as single source of truth`

All changes ship in one atomic PR. The steps below are execution order within the PR, not separate merge points.

**Why one PR works:**
- Changes are tightly coupled — switching the CLI embed path without deleting the old source is just noise
- Single `git revert` is simpler than reverting 7 PRs
- Private repo, single developer — no coordination overhead
- CI validates the final state, not intermediate states

---

## Implementation Steps

### Step 1 — Validate baseline

- **Action:** Run `cargo xtask ci-check` and confirm green
- **Action:** Run `wavecraft create BaselineTest --output target/tmp/baseline --no-git` and confirm compiled
- **Why:** Known-good state before any changes
- **Risk:** Low

---

### Step 2 — Create `sdk-template/` at repo root

- **Action:** Copy `cli/sdk-templates/new-project/react/*` → `sdk-template/`
- **Files created:** All 25 template files (3 `.template` + 22 plain), including:
  - `sdk-template/Cargo.toml.template`
  - `sdk-template/engine/Cargo.toml.template`
  - `sdk-template/engine/xtask/Cargo.toml.template`
  - `sdk-template/engine/src/lib.rs`
  - `sdk-template/engine/src/processors/{mod.rs, oscillator.rs}`
  - `sdk-template/ui/src/App.tsx`, `main.tsx`, `index.css`, `vite-env.d.ts`
  - `sdk-template/ui/package.json`, `vite.config.ts`, config files
  - `sdk-template/.gitignore`, `LICENSE`, `README.md`
- **Action:** Update `sdk-template/README.md` to document canonical purpose
- **Risk:** Low — purely additive

---

### Step 3 — Update root `.gitignore`

- **File:** `.gitignore`
- **Action:** Add:
  ```
  # SDK template — build artifacts
  /sdk-template/engine/target/
  /sdk-template/ui/node_modules/
  /sdk-template/ui/dist/

  # SDK template — generated by scripts/setup-dev-template.sh
  /sdk-template/Cargo.toml
  /sdk-template/engine/Cargo.toml
  /sdk-template/engine/xtask/Cargo.toml
  ```
- **Why:** Template artifacts and dev-mode generated files must not be committed
- **Risk:** Low

---

### Step 4 — Switch CLI template embedding

- **File:** `cli/src/template/mod.rs` (line 13)
- **Action:** Change:
  ```rust
  // Before (lines 11-13):
  // The template lives in cli/sdk-templates/new-project/react/ and is packaged directly with the CLI crate.
  // Structure: sdk-templates/new-project/<variant>/ — currently only "react" variant exists.
  static TEMPLATE_DIR: Dir = include_dir!("$CARGO_MANIFEST_DIR/sdk-templates/new-project/react");

  // After:
  // The canonical template lives in sdk-template/ at the repo root and is embedded into the CLI binary.
  static TEMPLATE_DIR: Dir = include_dir!("$CARGO_MANIFEST_DIR/../sdk-template");
  ```
- **Why:** CLI reads from canonical source. Output unchanged.
- **Risk:** Low — path is stable (CLI is git-only, not published to crates.io)

---

### Step 5 — Create dev template setup script

- **File:** `scripts/setup-dev-template.sh` (NEW)
- **Action:** Create script that:
  1. Copies each `.template` file → concrete file (strips `.template` extension)
  2. Replaces template variables with dev defaults:
     - `{{plugin_name}}` → `wavecraft-dev-template`
     - `{{plugin_name_snake}}` → `wavecraft_dev_template`
     - `{{plugin_name_pascal}}` → `WavecraftDevTemplate`
     - `{{plugin_name_title}}` → `Wavecraft Dev Template`
     - `{{author_name}}` → `Wavecraft SDK`
     - `{{author_email}}` → `dev@wavecraft.dev`
     - `{{homepage}}` → `https://github.com/RonHouben/wavecraft`
     - `{{sdk_version}}` → `dev` (overridden by local path deps anyway)
     - `{{year}}` → current year
  3. Replaces git dependencies with local path dependencies (same transformation as `--local-sdk`)
  4. Runs `npm install` in `sdk-template/ui`
- **Why:** `.template` files contain `{{placeholders}}` that won't compile. Dev mode needs concrete files.
- **Risk:** Medium — sed replacement must cover all 9 variables

---

### Step 6 — Rewire SDK-mode project detection

- **File:** `cli/src/project/detection.rs` (lines 64–94)
- **Action:** Replace SDK-mode branch:
  ```rust
  // Before (lines 64-86):
  if is_sdk_repo(&engine_cargo_toml)? {
      let example_dir = engine_dir.join("crates").join("wavecraft-example");
      let example_cargo = example_dir.join("Cargo.toml");
      if !example_dir.is_dir() || !example_cargo.is_file() {
          bail!(
              "SDK mode detected but 'engine/crates/wavecraft-example/' is missing.\n\
               This crate is required to run the dev server from the SDK repo."
          );
      }
      return Ok(Self {
          ui_dir,
          engine_dir: example_dir,
          ui_package_json,
          engine_cargo_toml: example_cargo,
          sdk_mode: true,
      });
  }

  // After:
  if is_sdk_repo(&engine_cargo_toml)? {
      let repo_root = start_dir;
      let template_dir = repo_root.join("sdk-template");
      let template_engine = template_dir.join("engine");
      let template_engine_cargo = template_engine.join("Cargo.toml");
      let template_ui = template_dir.join("ui");
      let template_ui_package_json = template_ui.join("package.json");

      if !template_dir.is_dir() {
          bail!(
              "SDK mode detected but 'sdk-template/' directory is missing.\n\
               This is required to run the dev server from the SDK repo."
          );
      }

      if !template_engine_cargo.is_file() {
          bail!(
              "SDK mode detected but 'sdk-template/engine/Cargo.toml' not found.\n\
               Run the setup script first:\n\n\
               \t./scripts/setup-dev-template.sh\n\n\
               This processes .template files for local development."
          );
      }

      if !template_ui_package_json.is_file() {
          bail!(
              "SDK mode detected but 'sdk-template/ui/package.json' is missing.\n\
               Ensure the sdk-template/ directory is complete."
          );
      }

      return Ok(Self {
          ui_dir: template_ui,
          engine_dir: template_engine,
          ui_package_json: template_ui_package_json,
          engine_cargo_toml: template_engine_cargo,
          sdk_mode: true,
      });
  }
  ```
- **Why:** Dev mode targets canonical template instead of wavecraft-example
- **Risk:** High — core developer workflow change

---

### Step 7 — Add Vite aliases for SDK-mode package development

- **File:** `sdk-template/ui/vite.config.ts`
- **Action:** Add conditional alias resolution:
  ```typescript
  import fs from 'node:fs';
  import path from 'node:path';

  // Detect SDK development mode (sdk-template lives inside wavecraft repo)
  const isSDKMode = fs.existsSync(path.resolve(__dirname, '../../engine/crates/wavecraft-core'));

  export default defineConfig({
    plugins: [react()],
    base: './',
    resolve: {
      alias: isSDKMode ? {
        '@wavecraft/core': path.resolve(__dirname, '../../ui/packages/core/src'),
        '@wavecraft/components': path.resolve(__dirname, '../../ui/packages/components/src'),
      } : {},
    },
    // ... rest unchanged
  });
  ```
- **Why:** In SDK mode, package edits in `ui/packages/*/src/` reflect immediately via live source. In generated user projects, `isSDKMode` is `false` so packages come from `node_modules`.
- **Risk:** Medium — verify alias works in SDK mode AND doesn't fire in user projects

---

### Step 8 — Delete legacy paths

- **Action:** `rm -rf cli/sdk-templates/` — CLI now embeds from `sdk-template/`
- **Action:** `rm -rf engine/crates/wavecraft-example/` — dev mode now targets `sdk-template/engine/`
- **Why:** Both fully superseded
- **Risk:** Low — consumers already rewired in steps 4 and 6

---

### Step 9 — Remove `ui/src/` dev app

- **Files to DELETE:**
  - `ui/src/App.tsx`, `ui/src/main.tsx`, `ui/src/index.css`, `ui/src/vite-env.d.ts`
  - `ui/src/test/` (move test utilities to `ui/packages/core/test/` if still needed)
  - `ui/index.html`
- **Files to EDIT:**
  - `ui/package.json` — Remove `dev`, `build` (app build), `preview` scripts. Keep `test`, `lint`, `format`, `typecheck`, `build:lib`, `workspaces`.
  - `ui/vite.config.ts` — Remove or simplify (no dev app config/version-from-cargo logic needed)
- **Files to KEEP (unchanged):**
  - `ui/packages/` — all npm packages
  - `ui/vitest.config.ts` — package test runner
  - `ui/tailwind.config.js`, `ui/postcss.config.js` — package styling
  - `ui/eslint.config.js` — package linting
  - `ui/tsconfig.json` — package type checking
  - `ui/playwright.config.ts` — visual testing
- **Why:** `ui/` becomes a pure npm package workspace
- **Risk:** Medium — verify `npm test` and lint still work for packages

---

### Step 10 — Update CI workflows

- **File:** `.github/workflows/continuous-deploy.yml` (line 59)
- **Action:** Change path filter `cli/sdk-templates/**` → `sdk-template/**`
- **File:** `.github/workflows/template-validation.yml`
- **Action:** Review — validates generated output via `wavecraft create`, likely no changes needed
- **Action:** Run `grep -r "sdk-templates\|wavecraft-example\|ui/src" .github/` and fix remaining refs
- **Risk:** Low

---

### Step 11 — Update documentation

- `docs/architecture/high-level-design.md` — Update repo structure: add `sdk-template/`, remove `cli/sdk-templates/`, remove `wavecraft-example`
- `docs/architecture/development-workflows.md` — Update dev setup: `./scripts/setup-dev-template.sh` → `cargo xtask dev`, UI at `sdk-template/ui/`, engine at `sdk-template/engine/`
- `docs/guides/sdk-getting-started.md` — Replace `wavecraft-example` references with `sdk-template/`
- `docs/architecture/sdk-architecture.md` — Update template location
- `CONTRIBUTING.md` — Add dev workflow section pointing to `sdk-template/ui/`
- **Risk:** Low

---

### Step 12 — Stale reference sweep and final verification

- **Action:** Comprehensive grep:
  ```bash
  grep -rn "sdk-templates" . --include="*.rs" --include="*.yml" --include="*.toml" --include="*.sh" --include="*.md" | grep -v "_archive" | grep -v ".git/"
  grep -rn "wavecraft-example" . --include="*.rs" --include="*.yml" --include="*.toml" --include="*.sh" --include="*.md" | grep -v "_archive" | grep -v ".git/"
  ```
- **Action:** Full verification suite (see below)
- **Risk:** Low

---

## Verification Checklist

Run all before opening the PR:

```bash
# 1. CLI builds and generates projects
cargo build --manifest-path cli/Cargo.toml
cargo run --manifest-path cli/Cargo.toml -- create test-final --output target/tmp/test-final --no-git
cd target/tmp/test-final/engine && cargo clippy --all-targets -- -D warnings
cd ../../../..

# 2. Engine workspace compiles (without wavecraft-example)
cargo check --manifest-path engine/Cargo.toml --workspace

# 3. Dev mode works end-to-end
./scripts/setup-dev-template.sh
cargo xtask dev
# → Verify in browser:
#   - http://localhost:5173 loads UI
#   - WebSocket connects, parameters appear
#   - Edit sdk-template/ui/src/App.tsx → HMR updates browser
#   - Edit sdk-template/engine/src/lib.rs → engine recompiles
#   - Edit ui/packages/core/src/*.ts → change reflected in dev UI
# → Ctrl+C to stop

# 4. Package tests still pass
cd ui && npm test && cd ..

# 5. Full CI suite
cargo xtask ci-check

# 6. No stale references
grep -rn "sdk-templates" . --include="*.rs" --include="*.yml" --include="*.toml" --include="*.sh" | grep -v "_archive" | grep -v ".git/"
grep -rn "wavecraft-example" . --include="*.rs" --include="*.yml" --include="*.toml" --include="*.sh" | grep -v "_archive" | grep -v ".git/"
```

### Manual Smoke Test (required)

- [ ] `./scripts/setup-dev-template.sh` completes without errors
- [ ] `cargo xtask dev` starts WS + Vite servers
- [ ] UI loads at `http://localhost:5173`
- [ ] WebSocket connects and parameters appear
- [ ] HMR works for `sdk-template/ui/src/App.tsx` edits
- [ ] Engine hot-reload works for `sdk-template/engine/src/lib.rs` edits
- [ ] Package alias works: edit `ui/packages/core/src/*.ts` → reflected in dev UI
- [ ] Clean shutdown on Ctrl+C
- [ ] `wavecraft create` still produces compilable projects

---

## Testing Strategy

| What | How | When |
|------|-----|------|
| CLI template generation | `wavecraft create --output target/tmp/test --no-git` + clippy | Step 12 |
| Engine workspace | `cargo check --workspace` | Step 12 |
| Dev server end-to-end | Manual smoke test | Step 12 |
| Package tests | `cd ui && npm test` | Step 12 |
| Full CI | `cargo xtask ci-check` | Step 12 |
| Stale reference scan | grep sweep | Step 12 |

---

## Risks & Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| `include_dir!` path breaks during `cargo package` | Medium | High | CLI is git-only; not published to crates.io |
| Developers forget `setup-dev-template.sh` before `xtask dev` | High | Low | Clear error message with exact command in detection code |
| Template variable replacement fails in setup script | Low | Medium | Explicit sed patterns; verify all 9 variables |
| Vite alias breaks generated user projects | Low | High | `isSDKMode` check absent in user projects — aliases disabled |
| `npm test` breaks after `ui/src` removal | Low | Medium | Verify vitest config scopes to `packages/` |
| Large PR is hard to review | Medium | Low | Changes are logically grouped; deletions are obvious |

---

## Success Criteria

- [ ] Single canonical scaffold at `sdk-template/`
- [ ] `wavecraft create` embeds from `sdk-template/`
- [ ] `cargo xtask dev` runs against `sdk-template/`
- [ ] `cli/sdk-templates/new-project/react/` deleted
- [ ] `engine/crates/wavecraft-example/` deleted
- [ ] `ui/src/` removed; `ui/` is package workspace only
- [ ] CI green on all workflows
- [ ] No grep matches for old paths in live code/config
- [ ] Package development workflow preserved via Vite aliases

---

## Estimated Effort

**Single PR, ~6–8 hours total:**

| Step | Effort | Risk |
|------|--------|------|
| Steps 1–3 (scaffold + gitignore) | ~30 min | Low |
| Step 4 (CLI embed switch) | ~15 min | Low |
| Step 5 (setup script) | ~1 hour | Medium |
| Step 6 (detection rewrite) | ~1 hour | **High** |
| Step 7 (Vite aliases) | ~30 min | Medium |
| Steps 8–9 (deletions) | ~30 min | Low |
| Steps 10–11 (CI + docs) | ~1 hour | Low |
| Step 12 (verification) | ~1–2 hours | — |

---

## Related Documents

- [Low-Level Design](./low-level-design-canonical-sdk-template.md) — Architecture rationale and data flow changes
- [High-Level Design](../../architecture/high-level-design.md) — Overall repo architecture
- [Development Workflows](../../architecture/development-workflows.md) — Dev setup docs (updated in Step 11)
- [SDK Architecture](../../architecture/sdk-architecture.md) — Crate and npm package structure
