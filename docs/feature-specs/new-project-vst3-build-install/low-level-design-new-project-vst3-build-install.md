# Low-Level Design: New Project VST3 Build + Install

**Feature Name:** `new-project-vst3-build-install`  
**Status:** Draft  
**Created:** 2026-02-17  
**Author:** Architect (approved decisions), persisted by DocWriter

---

## 1. Overview

### 1.1 Purpose

This design ensures that a project generated with `wavecraft create myProject` can be built into a real VST3 bundle and installed to the macOS user plugin directory for immediate DAW testing.

### 1.2 Scope

- Generated projects must support **build + install of VST3** on macOS.
- Top-level CLI must provide canonical user-facing entrypoint:
  - `wavecraft bundle --install`
- Generated `xtask` command contract must include:
  - `bundle`
  - `bundle --install`
- Build outputs are sourced from `engine/target/bundled`.
- Install target includes macOS user plugin directory:
  - `~/Library/Audio/Plug-Ins/VST3`
- Optional CLAP installation path support may be included if the generated project emits CLAP bundles.

### 1.3 Out of Scope

- Non-macOS install behavior (Windows/Linux) in this feature.
- New plugin formats beyond currently generated artifacts.
- DAW-specific validation automation in this phase.

### 1.4 Success Statement

After scaffolding a new project, the developer can run the generated `xtask` commands and get a valid VST3 bundle copied to the user plugin location, with clear diagnostics when something goes wrong.

---

## 2. User Story and Expected Behavior

**User story:**  
_As a user that created a new project using `wavecraft create myProject`, I want to be able to build it so the actual VST will be created that can be installed into the DAW._

### 2.1 Expected Flow

1. User creates a project via `wavecraft create myProject`.
2. User enters the generated project root directory.
3. User runs:

- `wavecraft bundle --install`

4. The project either:
   - Produces and installs the VST3 (and optional CLAP), or
   - Fails fast with actionable diagnostics and next steps.

### 2.2 Working-directory behavior

- `wavecraft bundle --install` must execute from a valid Wavecraft project root (or resolve project root deterministically using context detection utilities).
- If invoked outside a valid project root, command must fail with actionable guidance, including:
  - why context is invalid,
  - how to navigate to the project root,
  - and the command to rerun.

---

## 3. Command Contract (Top-level CLI + delegated xtask)

The command surface is split into a canonical user contract and delegated implementation contract.

### 3.1 Canonical user-facing command (top-level CLI)

**Goal:** Provide a single, predictable DAW-testing entrypoint.

**Command:**

- `wavecraft bundle --install`

**Behavior:**

- Validates/derives project context from current working directory.
- Delegates execution to generated-project `cargo xtask bundle --install`.
- Surfaces delegated failure diagnostics without obscuring root cause.
- Is the canonical and only documented user-facing install workflow.

### 3.2 Delegated generated-project contract (`xtask`)

Generated projects must expose a stable delegated command contract:

### 3.2.1 `bundle`

**Goal:** Build plugin bundles into `engine/target/bundled`.  
**Behavior:**

- Invokes project build pipeline required to produce VST3 bundle artifacts.
- Verifies expected VST3 output exists under `engine/target/bundled`.
- Returns non-zero with clear error if bundle output is missing.

### 3.2.2 `bundle --install`

**Goal:** One-step build + install workflow.  
**Behavior:**

- Runs bundle stage first.
- On successful bundle generation, executes install stage.
- Fails immediately if bundle stage fails (install stage must not run).
- Remains implementation-level delegated mechanism behind `wavecraft bundle --install`.

### 3.3 Internal install stage (non-contractual)

The generated `xtask` may keep reusable internal install routines (including optional preview or dry-run helpers) to support implementation quality and diagnostics. These internals are explicitly **not** part of the public command contract and must not be documented as required user-facing commands.

---

## 4. Paths and Artifact Model

### 4.1 Source Artifacts

Primary source root:

- `engine/target/bundled`

Expected content model:

- One VST3 bundle directory per plugin build.
- Optional CLAP bundle directory when generated by project setup.

### 4.2 Install Destinations (macOS user-level)

- VST3: `~/Library/Audio/Plug-Ins/VST3`
- Optional CLAP: `~/Library/Audio/Plug-Ins/CLAP`

### 4.3 Path Resolution Rules

- Resolve `~` to current user home directory.
- Create destination directory if missing during install execution.
- Use deterministic copy semantics (replace existing bundle of same name).

---

## 5. Failure Modes and Diagnostics

### 5.1 Missing Bundle Output

**Condition:** Bundle build failed, produced no expected output, or install stage cannot find artifacts under `engine/target/bundled`.  
**Diagnostic requirements:**

- Explicitly state missing source path under `engine/target/bundled`.
- Suggest recovery command:
  - `cargo xtask bundle --install`
- Exit non-zero.

### 5.2 Permission / Filesystem Errors

**Condition:** Copy/create fails due to permissions, locked files, or invalid path state.  
**Diagnostic requirements:**

- Include failing operation (`create_dir`, `copy`, `replace`) and target path.
- Include underlying OS error string.
- Suggest remediation:
  - Verify write permission in `~/Library/Audio/Plug-Ins/VST3`
  - Close DAW if plugin file is locked
  - Re-run `wavecraft bundle --install` after fix
- Exit non-zero.

### 5.3 Invalid project context / wrong working directory

**Condition:** User runs `wavecraft bundle --install` outside a valid Wavecraft project root, or in an unresolvable directory context.

**Diagnostic requirements:**

- Explain invalid context and expected project-root markers.
- Print current directory and guidance to navigate to project root.
- Suggest exact recovery command from project root:
  - `wavecraft bundle --install`
- Exit non-zero.

### 5.4 Delegated xtask failure propagation

**Condition:** Top-level CLI delegates to generated-project xtask and xtask exits non-zero.

**Diagnostic requirements:**

- Preserve underlying xtask failure diagnostics in CLI output.
- Include delegated command that failed and exit code.
- Avoid replacing specific xtask error with generic wrapper-only message.
- Exit non-zero.

### 5.5 Docs Drift / Command Drift

**Condition:** Generated project documentation and actual `xtask` behavior diverge.  
**Diagnostic requirements:**

- During template validation, assert command availability and expected flags.
- Fail validation when the canonical install workflow or behavior contract changes without docs updates.
- Provide clear pointer to docs/spec sections requiring updates.

---

## 6. Impacted Components

### 6.1 sdk-template xtask

Expected updates in generated template `xtask` implementation to provide and enforce:

- `bundle`
- `bundle --install`
- artifact discovery from `engine/target/bundled`
- path-safe install logic and diagnostics
- internal install routines treated as implementation details, not public contract

### 6.2 CLI Post-Create Guidance

`wavecraft create` post-create output/help text should direct users to the new canonical flow, e.g.:

- `wavecraft bundle --install`

### 6.3 Top-level CLI command surface responsibilities

Top-level CLI command surface must own command routing, context checks, and delegation:

- `cli/src/main.rs`
  - register/route `bundle` command entrypoint.
- `cli/src/commands/mod.rs`
  - command module wiring/export for `bundle` command.
- `cli/src/commands/bundle.rs` (new or existing)
  - implement project-root/context validation,
  - delegate to generated-project `cargo xtask bundle --install`,
  - propagate underlying diagnostics and exit behavior.
- project-root/context detection utilities (new or existing helper module)
  - provide reusable root-detection and invalid-context diagnostics.

### 6.4 Documentation

Update generated project docs and SDK docs where applicable to reflect:

- canonical command contract (`bundle`, `bundle --install`)
- artifact/output paths
- install locations
- troubleshooting guidance

### 6.4 Template Validation (engine/xtask)

Validation pipeline should verify generated projects:

- expose required canonical `xtask` commands/flags,
- produce expected bundle outputs,
- keep docs aligned with actual behavior,
- and prevent standalone install commands from being treated as required public surface.

---

## 7. Architecture and Data Flow

### 7.1 Build + Install Pipeline

1. `wavecraft bundle --install` resolves/validates project context.
2. Top-level CLI delegates to generated-project `cargo xtask bundle --install`.
3. Delegated bundle stage emits bundle(s) to `engine/target/bundled`.
4. Delegated install stage resolves destination directories.
5. Delegated install stage copies/replaces bundle(s) into user plugin dirs.
6. CLI prints/forwards final installed paths and completion status.

### 7.2 Safety and Determinism

- Install never assumes artifacts exist; must validate first.
- Combined flow (`bundle --install`) enforces stage ordering and short-circuit on failure.

---

## 8. Implementation Guidance for Planner/Coder

### 8.1 Planner Guidance

- Break work into template xtask canonical contract, CLI messaging, docs alignment, and validation updates.
- Identify all files in `sdk-template/` and `engine/xtask` involved in command wiring and template checks.
- Include explicit negative-test scenarios for missing bundle + permission errors.

### 8.2 Coder Guidance

- Implement top-level CLI command parsing with clear, stable flags.
- Centralize project-root detection/context validation for `wavecraft bundle --install`.
- Centralize path constants for source and destination dirs.
- Reuse a shared internal installer routine for `bundle --install` execution to avoid drift.
- Keep any standalone install/dry-run helpers internal and non-contractual.
- Use structured, actionable error messages rather than generic failures.

### 8.3 Testing Guidance

At minimum, verify:

- `wavecraft bundle --install` succeeds from a valid project root.
- `wavecraft bundle --install` fails outside project root with actionable guidance.
- `wavecraft bundle --install` propagates delegated xtask failure diagnostics.
- delegated `bundle` creates expected VST3 artifact location.
- delegated `bundle --install` performs both stages in order.
- delegated `bundle --install` fails fast when bundle output is missing and suggests recovery.
- install path behavior works with existing bundle replacement.

---

## 9. Acceptance Criteria

- [ ] Top-level CLI exposes canonical user-facing entrypoint `wavecraft bundle --install`.
- [ ] `wavecraft bundle --install` succeeds when run from a valid project root.
- [ ] `wavecraft bundle --install` fails outside project root with actionable guidance.
- [ ] `wavecraft bundle --install` propagates underlying delegated xtask failure diagnostics.
- [ ] A newly generated project exposes delegated `cargo xtask bundle`.
- [ ] A newly generated project supports delegated `cargo xtask bundle --install`.
- [ ] VST3 artifacts are read from `engine/target/bundled`.
- [ ] VST3 installs to `~/Library/Audio/Plug-Ins/VST3` on macOS.
- [ ] Optional CLAP install path is handled consistently when CLAP artifacts exist.
- [ ] Missing bundle errors are explicit and include `wavecraft bundle --install` as recovery.
- [ ] Permission/copy failures include path + OS error + remediation hint.
- [ ] Template validation catches canonical-command/docs drift.
- [ ] Generated docs reflect the actual canonical command contract and paths.

---

## 10. Risks and Mitigations

| Risk                                                    | Impact | Mitigation                                                                |
| ------------------------------------------------------- | ------ | ------------------------------------------------------------------------- |
| Inconsistent command behavior across template revisions | High   | Lock contract in template validation and feature-spec acceptance criteria |
| Silent install failures due to weak diagnostics         | High   | Require actionable errors with operation/path/OS cause                    |
| Docs become stale as command behavior evolves           | Medium | Add drift checks in validation and update docs with every contract change |
| Optional CLAP handling introduces edge-case confusion   | Medium | Keep VST3 path mandatory, CLAP explicitly optional and clearly logged     |

---

## 11. Related Documents

- [High-Level Design](../../architecture/high-level-design.md) — Architecture overview and platform strategy
- [Coding Standards](../../architecture/coding-standards.md) — Project-wide conventions
- [Roadmap](../../roadmap.md) — Milestones and status tracking
- [SDK Architecture](../../architecture/sdk-architecture.md) — SDK/package structure and responsibilities
- [Development Workflows](../../architecture/development-workflows.md) — Build/dev workflow context
- [Plugin Formats](../../architecture/plugin-formats.md) — VST3/CLAP/AU format context
- [Agent Development Flow](../../architecture/agent-development-flow.md) — Handoff and artifact expectations

---

## 12. Revision History

| Date       | Version | Author              | Changes                                                    |
| ---------- | ------- | ------------------- | ---------------------------------------------------------- |
| 2026-02-17 | 0.1     | Architect/DocWriter | Initial low-level design persisted from approved decisions |
